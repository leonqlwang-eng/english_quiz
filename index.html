<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- SEO & Social Sharing -->
    <title>è‹±è¯­å•è¯å¤§é—¯å…³ | åŸºç¡€è¯æ±‡ç‰¹è®­</title>
    <meta name="description" content="è¶£å‘³è‹±è¯­å•è¯å¡«ç©ºæ¸¸æˆï¼ŒåŒ…å«100+åŸºç¡€é«˜é¢‘è¯æ±‡ï¼Œæ”¯æŒå‘éŸ³ã€æç¤ºä¸é”™é¢˜å¤ä¹ ã€‚">
    <meta property="og:title" content="è‹±è¯­å•è¯å¤§é—¯å…³">
    <meta property="og:description" content="æ¯å¤©10ä¸ªè¯ï¼Œè½»æ¾è®°å•è¯ï¼">
    
    <!-- Mobile App Experience (iOS/Android) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#e0c3fc">
    <link rel="apple-touch-icon" href="https://ui-avatars.com/api/?name=En&background=6c5ce7&color=fff&rounded=true">
    <link rel="shortcut icon" href="https://ui-avatars.com/api/?name=En&background=6c5ce7&color=fff&rounded=true">

    <style>
        :root {
            --primary-color: #4facfe;
            --secondary-color: #00f2fe;
            --accent-color: #ff9a9e;
            --text-color: #2d3436;
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); /* æ›´æŸ”å’Œçš„æŠ¤çœ¼èƒŒæ™¯ */
            --card-bg: rgba(255, 255, 255, 0.96);
            --input-border: #dfe6e9;
            --success: #2ecc71;
            --error: #e74c3c;
            --warn: #f1c40f;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: var(--bg-gradient);
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-color);
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* ç²’å­ç”»å¸ƒ */
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; }

        .container {
            width: 90%;
            max-width: 600px;
            background: var(--card-bg);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.08);
            padding: 2.5rem 2rem;
            text-align: center;
            position: relative;
            backdrop-filter: blur(12px);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            z-index: 10;
        }

        h1 { color: #5352ed; margin: 0 0 0.5rem 0; font-size: 1.8rem; letter-spacing: -0.5px; }
        p { color: #636e72; margin-bottom: 2rem; font-size: 0.95rem; }

        /* æŒ‰é’®ç³»ç»Ÿ */
        .btn {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white; border: none; padding: 14px 28px; font-size: 1rem; border-radius: 30px;
            cursor: pointer; transition: all 0.2s; font-weight: 600; margin: 8px;
            display: inline-flex; align-items: center; justify-content: center; gap: 6px;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(108, 92, 231, 0.4); }
        .btn:active { transform: scale(0.98); }
        
        .btn-outline { background: transparent; border: 2px solid #6c5ce7; color: #6c5ce7; box-shadow: none; }
        .btn-outline:hover { background: #6c5ce7; color: white; }
        .btn-small { padding: 6px 16px; font-size: 0.85rem; height: auto; }
        .btn-icon { background: rgba(0,0,0,0.05); color: #6c5ce7; font-size: 1.4rem; padding: 8px; border-radius: 50%; width: 40px; height: 40px; box-shadow: none; }
        .btn-icon:hover { background: rgba(108, 92, 231, 0.1); transform: rotate(10deg); }

        /* æ¸¸æˆç•Œé¢ */
        .game-toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .level-badge { background: #ff7675; color: white; padding: 6px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; }

        .progress-bar { width: 100%; height: 6px; background: #f0f2f5; border-radius: 3px; margin-bottom: 2rem; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #4facfe, #00f2fe); width: 0%; transition: width 0.4s cubic-bezier(0.22, 0.61, 0.36, 1); }

        .word-meaning { font-size: 1.8rem; font-weight: 700; color: #2d3436; margin: 15px 0 5px; letter-spacing: -0.5px; }
        .word-phonetic { color: #b2bec3; font-size: 1.1rem; font-family: 'Arial', sans-serif; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: color 0.2s; }
        .word-phonetic:hover { color: #6c5ce7; }

        .input-container { display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; margin: 2.5rem 0; min-height: 60px; }
        .char-box {
            width: 48px; height: 58px; font-size: 1.8rem; text-align: center; border: 2px solid #e1e4e8;
            border-radius: 12px; background: white; color: #2d3436;
            transition: all 0.2s; caret-color: #6c5ce7; font-weight: 600;
        }
        .char-box:focus { border-color: #6c5ce7; transform: translateY(-4px); box-shadow: 0 8px 20px rgba(108, 92, 231, 0.15); outline: none; }
        .char-box.static { background-color: #f8f9fa; border-color: transparent; color: #636e72; user-select: none; }
        .char-box.space { width: 20px; border: none; background: transparent; }
        .char-box.correct { border-color: #2ecc71; background-color: #f0fff4; color: #2ecc71; }
        .char-box.wrong { border-color: #ff7675; background-color: #fff5f5; color: #ff7675; animation: shake 0.4s; }
        .char-box.hint-revealed { border-color: #ffeaa7; color: #e17055; background: #fffdf0; }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-6px); } 75% { transform: translateX(6px); } }

        /* åŒºåŸŸåˆ‡æ¢ */
        .section { display: none; opacity: 0; transform: translateY(15px); transition: opacity 0.4s, transform 0.4s; }
        .section.active { display: block; opacity: 1; transform: translateY(0); }

        /* æ–‡ä»¶ä¸Šä¼ ç¾åŒ– */
        .file-upload-wrapper {
            margin: 25px 0; border: 2px dashed #d1d8e0; padding: 35px 20px; border-radius: 18px; background: #fdfdfd; 
            cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;
        }
        .file-upload-wrapper:hover { border-color: #6c5ce7; background: #f8f9fa; }
        .file-upload-wrapper:active { background: #f1f2f6; }
        
        .resume-banner {
            background: #e0f7fa; color: #006064; padding: 12px 20px; border-radius: 12px; margin-bottom: 25px;
            display: flex; justify-content: space-between; align-items: center; border: 1px solid #b2ebf2;
        }

        /* å¼¹çª— */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 2000; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.active { display: flex; opacity: 1; }
        .modal-box {
            background: white; width: 85%; max-width: 480px; padding: 30px; border-radius: 24px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.2); text-align: left; max-height: 75vh; overflow-y: auto; transform: scale(0.9); transition: transform 0.3s;
        }
        .modal-overlay.active .modal-box { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #f1f2f6; padding-bottom: 15px; }
        .modal-title { font-size: 1.25rem; font-weight: 800; color: #2d3436; }
        .close-btn { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: #b2bec3; padding: 0; line-height: 1; }
        .close-btn:hover { color: #2d3436; }
        
        .release-item { margin-bottom: 20px; }
        .release-ver { display: inline-block; background: #6c5ce7; color: white; padding: 2px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; margin-right: 8px; vertical-align: middle; }
        .release-date { font-size: 0.8rem; color: #b2bec3; vertical-align: middle; }
        .release-content { margin-top: 8px; font-size: 0.95rem; color: #636e72; line-height: 1.6; padding-left: 20px; list-style-type: disc; }
        .release-content li { margin-bottom: 4px; }

        /* ç»“ç®—é¡µ */
        .score-circle {
            width: 140px; height: 140px; border-radius: 50%; background: #fdcb6e; color: white;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            margin: 0 auto 2rem; box-shadow: 0 10px 30px rgba(253, 203, 110, 0.4); border: 6px solid white;
        }
        .score-val { font-size: 3.5rem; font-weight: 800; line-height: 1; }
        .score-label { font-size: 0.85rem; opacity: 0.9; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

        .wrong-list { text-align: left; background: #fff5f5; padding: 1.5rem; border-radius: 16px; margin-bottom: 2rem; max-height: 250px; overflow-y: auto; border: 1px solid #ffccc7; }
        .wrong-item { border-bottom: 1px dashed #ffccc7; padding: 10px 0; color: #c0392b; display: flex; justify-content: space-between; align-items: center; }
        .wrong-item:last-child { border-bottom: none; }
        .wrong-en { font-weight: bold; font-size: 1.05rem; }
        .wrong-cn { color: #e17055; font-size: 0.9rem; }

        .copyright { margin-top: 40px; font-size: 0.8rem; color: #b2bec3; }

        @media (max-width: 480px) {
            .container { width: 92%; padding: 2rem 1.5rem; border-radius: 20px; }
            .char-box { width: 38px; height: 48px; font-size: 1.5rem; border-radius: 8px; }
            .word-meaning { font-size: 1.4rem; }
            .modal-box { width: 90%; padding: 20px; }
        }
    </style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>

<div class="container">
    
    <!-- 1. èµ·å§‹é¡µ -->
    <div id="setupArea" class="section active">
        <h1>English Challenge</h1>
        <p>åŸºç¡€è¯æ±‡å¼ºåŒ–ç‰¹è®­</p>
        
        <!-- æ¢å¤å­˜æ¡£æç¤º -->
        <div id="resumeBanner" class="resume-banner" style="display:none;">
            <div>
                <div style="font-weight:bold; font-size:0.9rem;">å‘ç°æœªå®Œæˆçš„è¿›åº¦</div>
                <div id="resumeInfo" style="font-size:0.8rem; opacity:0.8;">Level 1 - 5/10 words</div>
            </div>
            <button class="btn btn-small" style="background:#0097a7; box-shadow:none;" onclick="resumeGame()">ç»§ç»­</button>
        </div>

        <button class="btn" style="width:80%; justify-content: center;" onclick="startWithDefault()">
            ğŸš€ å¼€å§‹é—¯å…³ (éšæœº10è¯)
        </button>
        
        <div class="file-upload-wrapper" onclick="document.getElementById('fileInput').click()">
            <div style="font-size:2.2rem; margin-bottom:10px;">ğŸ“‚</div>
            <div style="font-weight:600; color:#2d3436;">ä¸Šä¼ è‡ªå®šä¹‰é¢˜åº“ (.txt)</div>
            <div style="font-size:0.85rem; color:#b2bec3; margin-top:5px;">æ”¯æŒå¤§é‡å•è¯ï¼Œç³»ç»Ÿè‡ªåŠ¨åˆ†æ‰¹è®­ç»ƒ</div>
            <input type="file" id="fileInput" accept=".txt,.csv" onchange="handleFileUpload(this)" style="display:none;">
        </div>

        <div style="margin-top:25px;">
            <button class="btn btn-outline btn-small" onclick="toggleModal('releaseModal')">ğŸ“œ Release Notes V2.2</button>
        </div>
        
        <div class="copyright">Â© 2026 English Challenge Online</div>
    </div>

    <!-- 2. æ¸¸æˆä¸»ç•Œé¢ -->
    <div id="gameArea" class="section">
        <div class="game-toolbar">
            <div id="levelBadge" class="level-badge">Level 1</div>
            <button class="btn btn-icon" onclick="toggleSound()" title="éŸ³æ•ˆå¼€å…³" id="soundToggleBtn">ğŸ”Š</button>
        </div>
        
        <div class="progress-bar">
            <div id="progressFill" class="progress-fill"></div>
        </div>

        <div id="wordMeaning" class="word-meaning">Meaning</div>
        <div id="wordPhonetic" class="word-phonetic" onclick="speakCurrentWord()">
            <span id="phoneticText">/IPA/</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
        </div>

        <div id="inputContainer" class="input-container">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>

        <div style="display:flex; justify-content:center; gap:15px; margin-top:30px;">
            <button class="btn btn-outline" onclick="useHint()" style="border-radius:12px; padding:10px 20px;">
                ğŸ’¡ æç¤º
            </button>
            <button id="submitBtn" class="btn" onclick="checkCurrentWord()" style="border-radius:12px; min-width:140px;">
                æäº¤ / Next
            </button>
        </div>
    </div>

    <!-- 3. ç»“ç®—é¡µ -->
    <div id="resultArea" class="section">
        <div class="score-circle" id="scoreDisplay">
            <div class="score-val">100</div>
            <div class="score-label">Score</div>
        </div>
        <div id="feedbackText" style="margin-bottom:2rem; font-size:1.1rem; line-height:1.6; color:#2d3436;"></div>
        
        <div id="wrongListContainer" class="wrong-list" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid #ffecec;">
                <strong style="color:#d63031;">é”™é¢˜æœ¬ (Review List)</strong>
                <button class="btn btn-small btn-outline" style="border-color:#ff7675; color:#ff7675;" onclick="exportWrongWords()">ğŸ“¥ å¯¼å‡º</button>
            </div>
            <div id="wrongListItems"></div>
        </div>

        <div style="display:flex; justify-content:center; flex-wrap:wrap; gap:10px;">
            <button id="nextLevelBtn" class="btn" onclick="startLevel2()">ğŸ”¥ è¿›å…¥ç¬¬äºŒå…³ (Hard)</button>
            <button id="restartBtn" class="btn" onclick="startNewSessionFromBank()" style="display:none;">ğŸ”„ æ¢ä¸€ç»„è¯ç»§ç»­ç»ƒ</button>
            <button class="btn btn-outline" onclick="goToHome()">ğŸ  è¿”å›é¦–é¡µ</button>
        </div>
    </div>
</div>

<!-- Release Note Modal -->
<div id="releaseModal" class="modal-overlay" onclick="if(event.target===this) toggleModal('releaseModal')">
    <div class="modal-box">
        <div class="modal-header">
            <div class="modal-title">æ›´æ–°è®°å½• (Release Notes)</div>
            <button class="close-btn" onclick="toggleModal('releaseModal')">&times;</button>
        </div>
        
        <div class="release-item">
            <span class="release-ver">V2.2 Online</span><span class="release-date">2026-02-26</span>
            <ul class="release-content">
                <li>ğŸ“š <strong>è¯åº“å¤§æ›´æ–°ï¼š</strong> é»˜è®¤é›†æˆ 100+ åŸºç¡€é«˜é¢‘è¯æ±‡ï¼ˆæ¶µç›– ability åˆ° collectï¼‰ã€‚</li>
                <li>âœ¨ <strong>çº¿ä¸Šä¼˜åŒ–ï¼š</strong> å¢åŠ ç§»åŠ¨ç«¯ PWA æ”¯æŒï¼Œä¼˜åŒ–è§¦å±ä½“éªŒã€‚</li>
                <li>ğŸ“± <strong>è¾“å…¥ä¼˜åŒ–ï¼š</strong> ç¦ç”¨æ‰‹æœºé”®ç›˜è‡ªåŠ¨çº é”™ï¼Œå¡«ç©ºæ›´é¡ºç•…ã€‚</li>
                <li>ğŸ¨ <strong>UI å‡çº§ï¼š</strong> æ›´æŸ”å’Œçš„é…è‰²ä¸äº¤äº’åŠ¨ç”»ã€‚</li>
            </ul>
        </div>

        <div class="release-item">
            <span class="release-ver">V2.1</span>
            <ul class="release-content">
                <li>ğŸ¤– <strong>æ™ºèƒ½åˆ†æ‰¹ï¼š</strong> æ— è®ºè¯åº“å¤šå¤§ï¼Œæ¯æ¬¡éšæœºæŠ½å– 10 ä¸ªè¯ï¼Œå‡è½»è®°å¿†è´Ÿæ‹…ã€‚</li>
                <li>ğŸ”„ <strong>æ— é™æ¨¡å¼ï¼š</strong> ç»“æŸåå¯â€œæ¢ä¸€ç»„â€ç»§ç»­æŒ‘æˆ˜ã€‚</li>
            </ul>
        </div>
        
        <div style="text-align:center; margin-top:30px; font-size:0.8rem; color:#b2bec3;">
            Designed for English Learners
        </div>
    </div>
</div>

<script>
    // --- é…ç½® ---
    const MAX_WORDS_PER_SESSION = 10;

    // --- æ•°æ® (Updated V2.2 Data) ---
    const defaultData = [
        { en: "ability", ph: "/É™ËˆbÉªlÉ™ti/", cn: "èƒ½åŠ›ï¼›æ‰èƒ½", type: "n." },
        { en: "above", ph: "/É™ËˆbÊŒv/", cn: "åœ¨â€¦â€¦ä¸Šé¢", type: "prep." },
        { en: "abroad", ph: "/É™ËˆbrÉ”Ëd/", cn: "åˆ°å›½å¤–ï¼›åœ¨å›½å¤–", type: "adv." },
        { en: "absent", ph: "/ËˆÃ¦bsÉ™nt/", cn: "ç¼ºå¸­çš„ï¼›ä¸åœ¨çš„", type: "adj." },
        { en: "accept", ph: "/É™kËˆsept/", cn: "æ¥å—ï¼›è®¤å¯", type: "v." },
        { en: "accident", ph: "/ËˆÃ¦ksÉªdÉ™nt/", cn: "äº‹æ•…ï¼›æ„å¤–çš„äº‹", type: "n." },
        { en: "achieve", ph: "/É™ËˆtÊƒiËv/", cn: "è¾¾åˆ°ï¼›å–å¾—", type: "v." },
        { en: "active", ph: "/ËˆÃ¦ktÉªv/", cn: "ç§¯æçš„ï¼›æ´»è·ƒçš„", type: "adj." },
        { en: "advantage", ph: "/É™dËˆvÉ‘ËntÉªdÊ’/", cn: "ä¼˜ç‚¹ï¼›ä¼˜åŠ¿", type: "n." },
        { en: "advice", ph: "/É™dËˆvaÉªs/", cn: "åŠå‘Šï¼›å»ºè®®", type: "n." },
        { en: "afford", ph: "/É™ËˆfÉ”Ëd/", cn: "ä¹°å¾—èµ·ï¼›è´Ÿæ‹…å¾—èµ·", type: "v." },
        { en: "against", ph: "/É™ËˆÉ¡enst/", cn: "åå¯¹ï¼›å€šé ç€", type: "prep." },
        { en: "agree", ph: "/É™ËˆÉ¡riË/", cn: "åŒæ„ï¼›èµæˆ", type: "v." },
        { en: "alive", ph: "/É™ËˆlaÉªv/", cn: "æ´»ç€çš„ï¼›å­˜åœ¨çš„", type: "adj." },
        { en: "allow", ph: "/É™ËˆlaÊŠ/", cn: "å…è®¸ï¼›å‡†è®¸", type: "v." },
        { en: "almost", ph: "/ËˆÉ”ËlmÉ™ÊŠst/", cn: "å‡ ä¹ï¼›å·®ä¸å¤š", type: "adv." },
        { en: "alone", ph: "/É™ËˆlÉ™ÊŠn/", cn: "å•ç‹¬çš„ï¼›å­¤ç‹¬çš„", type: "adj./adv." },
        { en: "already", ph: "/É”ËlËˆredi/", cn: "å·²ç»", type: "adv." },
        { en: "always", ph: "/ËˆÉ”ËlweÉªz/", cn: "æ€»æ˜¯ï¼›ä¸€ç›´", type: "adv." },
        { en: "amazing", ph: "/É™ËˆmeÉªzÉªÅ‹/", cn: "ä»¤äººæƒŠå¼‚çš„", type: "adj." },
        { en: "amount", ph: "/É™ËˆmaÊŠnt/", cn: "æ•°é‡ï¼›æ€»æ•°", type: "n." },
        { en: "ancient", ph: "/ËˆeÉªnÊƒÉ™nt/", cn: "å¤ä»£çš„ï¼›å¤è€çš„", type: "adj." },
        { en: "angry", ph: "/ËˆÃ¦Å‹É¡ri/", cn: "ç”Ÿæ°”çš„ï¼›æ„¤æ€’çš„", type: "adj." },
        { en: "animal", ph: "/ËˆÃ¦nÉªml/", cn: "åŠ¨ç‰©", type: "n." },
        { en: "another", ph: "/É™ËˆnÊŒÃ°É™/", cn: "å¦ä¸€ä¸ªï¼›åˆä¸€ä¸ª", type: "pron./adj." },
        { en: "answer", ph: "/ËˆÉ‘ËnsÉ™/", cn: "å›ç­”ï¼›ç­”æ¡ˆ", type: "n./v." },
        { en: "anyone", ph: "/ËˆeniwÊŒn/", cn: "ä»»ä½•äºº", type: "pron." },
        { en: "anything", ph: "/ËˆeniÎ¸ÉªÅ‹/", cn: "ä»»ä½•äº‹", type: "pron." },
        { en: "anywhere", ph: "/ËˆeniweÉ™/", cn: "ä»»ä½•åœ°æ–¹", type: "adv." },
        { en: "appear", ph: "/É™ËˆpÉªÉ™/", cn: "å‡ºç°ï¼›æ˜¾å¾—", type: "v." },
        { en: "apple", ph: "/ËˆÃ¦pl/", cn: "è‹¹æœ", type: "n." },
        { en: "area", ph: "/ËˆeÉ™riÉ™/", cn: "åœ°åŒºï¼›é¢ç§¯", type: "n." },
        { en: "argue", ph: "/ËˆÉ‘ËÉ¡juË/", cn: "äº‰è®ºï¼›è¾©è®º", type: "v." },
        { en: "around", ph: "/É™ËˆraÊŠnd/", cn: "åœ¨å‘¨å›´ï¼›å¤§çº¦", type: "adv./prep." },
        { en: "arrive", ph: "/É™ËˆraÉªv/", cn: "åˆ°è¾¾", type: "v." },
        { en: "article", ph: "/ËˆÉ‘ËtÉªkl/", cn: "æ–‡ç« ï¼›ç‰©å“", type: "n." },
        { en: "attention", ph: "/É™ËˆtenÊƒn/", cn: "æ³¨æ„ï¼›å…³å¿ƒ", type: "n." },
        { en: "available", ph: "/É™ËˆveÉªlÉ™bl/", cn: "å¯è·å¾—çš„ï¼›æœ‰ç©ºçš„", type: "adj." },
        { en: "avoid", ph: "/É™ËˆvÉ”Éªd/", cn: "é¿å…ï¼›èº²å¼€", type: "v." },
        { en: "awake", ph: "/É™ËˆweÉªk/", cn: "é†’ç€çš„", type: "adj." },
        { en: "background", ph: "/ËˆbÃ¦kÉ¡raÊŠnd/", cn: "èƒŒæ™¯", type: "n." },
        { en: "balance", ph: "/ËˆbÃ¦lÉ™ns/", cn: "å¹³è¡¡", type: "n./v." },
        { en: "beautiful", ph: "/ËˆbjuËtÉªfl/", cn: "ç¾ä¸½çš„", type: "adj." },
        { en: "because", ph: "/bÉªËˆkÉ’z/", cn: "å› ä¸º", type: "conj." },
        { en: "become", ph: "/bÉªËˆkÊŒm/", cn: "å˜æˆï¼›æˆä¸º", type: "v." },
        { en: "before", ph: "/bÉªËˆfÉ”Ë/", cn: "åœ¨â€¦â€¦ä¹‹å‰", type: "prep./conj." },
        { en: "begin", ph: "/bÉªËˆÉ¡Éªn/", cn: "å¼€å§‹", type: "v." },
        { en: "behavior", ph: "/bÉªËˆheÉªvjÉ™/", cn: "è¡Œä¸ºï¼›ä¸¾æ­¢", type: "n." },
        { en: "behind", ph: "/bÉªËˆhaÉªnd/", cn: "åœ¨â€¦â€¦åé¢", type: "prep." },
        { en: "believe", ph: "/bÉªËˆliËv/", cn: "ç›¸ä¿¡ï¼›è®¤ä¸º", type: "v." },
        { en: "belong", ph: "/bÉªËˆlÉ’Å‹/", cn: "å±äº", type: "v." },
        { en: "below", ph: "/bÉªËˆlÉ™ÊŠ/", cn: "åœ¨â€¦â€¦ä¸‹é¢", type: "prep." },
        { en: "beside", ph: "/bÉªËˆsaÉªd/", cn: "åœ¨â€¦â€¦æ—è¾¹", type: "prep." },
        { en: "between", ph: "/bÉªËˆtwiËn/", cn: "åœ¨â€¦â€¦ä¹‹é—´", type: "prep." },
        { en: "beyond", ph: "/bÉªËˆjÉ’nd/", cn: "è¶…å‡ºï¼›åœ¨â€¦â€¦çš„é‚£è¾¹", type: "prep." },
        { en: "blind", ph: "/blaÉªnd/", cn: "ççš„ï¼›ç›²ç›®çš„", type: "adj." },
        { en: "blood", ph: "/blÊŒd/", cn: "è¡€æ¶²", type: "n." },
        { en: "borrow", ph: "/ËˆbÉ’rÉ™ÊŠ/", cn: "å€Ÿå…¥", type: "v." },
        { en: "bottom", ph: "/ËˆbÉ’tÉ™m/", cn: "åº•éƒ¨", type: "n." },
        { en: "brave", ph: "/breÉªv/", cn: "å‹‡æ•¢çš„", type: "adj." },
        { en: "break", ph: "/breÉªk/", cn: "æ‰“ç ´ï¼›ä¼‘æ¯", type: "v./n." },
        { en: "bridge", ph: "/brÉªdÊ’/", cn: "æ¡¥", type: "n." },
        { en: "bright", ph: "/braÉªt/", cn: "æ˜äº®çš„ï¼›èªæ˜çš„", type: "adj." },
        { en: "bring", ph: "/brÉªÅ‹/", cn: "å¸¦æ¥", type: "v." },
        { en: "brother", ph: "/ËˆbrÊŒÃ°É™/", cn: "å…„å¼Ÿ", type: "n." },
        { en: "build", ph: "/bÉªld/", cn: "å»ºç­‘ï¼›å»ºé€ ", type: "v." },
        { en: "business", ph: "/ËˆbÉªznÉ™s/", cn: "å•†ä¸šï¼›ç”Ÿæ„", type: "n." },
        { en: "camera", ph: "/ËˆkÃ¦mÉ™rÉ™/", cn: "ç…§ç›¸æœº", type: "n." },
        { en: "cancel", ph: "/ËˆkÃ¦nsl/", cn: "å–æ¶ˆ", type: "v." },
        { en: "cancer", ph: "/ËˆkÃ¦nsÉ™/", cn: "ç™Œç—‡", type: "n." },
        { en: "capital", ph: "/ËˆkÃ¦pÉªtl/", cn: "é¦–éƒ½ï¼›èµ„æœ¬", type: "n." },
        { en: "careful", ph: "/ËˆkeÉ™fl/", cn: "å°å¿ƒçš„ï¼›ä»”ç»†çš„", type: "adj." },
        { en: "carry", ph: "/ËˆkÃ¦ri/", cn: "æºå¸¦ï¼›æ¬è¿", type: "v." },
        { en: "catch", ph: "/kÃ¦tÊƒ/", cn: "æŠ“ä½ï¼›èµ¶ä¸Š", type: "v." },
        { en: "cause", ph: "/kÉ”Ëz/", cn: "åŸå› ï¼›å¼•èµ·", type: "n./v." },
        { en: "celebrate", ph: "/ËˆselÉªbreÉªt/", cn: "åº†ç¥", type: "v." },
        { en: "center", ph: "/ËˆsentÉ™/", cn: "ä¸­å¿ƒ", type: "n." },
        { en: "century", ph: "/ËˆsentÊƒÉ™ri/", cn: "ä¸–çºªï¼›ç™¾å¹´", type: "n." },
        { en: "certain", ph: "/ËˆsÉœËtn/", cn: "ç¡®å®šçš„ï¼›æŸä¸€ä¸ª", type: "adj." },
        { en: "chance", ph: "/tÊƒÉ‘Ëns/", cn: "æœºä¼šï¼›å¯èƒ½æ€§", type: "n." },
        { en: "change", ph: "/tÊƒeÉªndÊ’/", cn: "æ”¹å˜ï¼›é›¶é’±", type: "v./n." },
        { en: "cheap", ph: "/tÊƒiËp/", cn: "ä¾¿å®œçš„", type: "adj." },
        { en: "check", ph: "/tÊƒek/", cn: "æ£€æŸ¥ï¼›æ ¸å¯¹", type: "v./n." },
        { en: "choice", ph: "/tÊƒÉ”Éªs/", cn: "é€‰æ‹©", type: "n." },
        { en: "choose", ph: "/tÊƒuËz/", cn: "é€‰æ‹©ï¼›å†³å®š", type: "v." },
        { en: "circle", ph: "/ËˆsÉœËkl/", cn: "åœ†åœˆï¼›åœˆå‡º", type: "n./v." },
        { en: "citizen", ph: "/ËˆsÉªtÉªzn/", cn: "å…¬æ°‘ï¼›å¸‚æ°‘", type: "n." },
        { en: "city", ph: "/ËˆsÉªti/", cn: "åŸå¸‚", type: "n." },
        { en: "classmate", ph: "/ËˆklÉ‘ËsmeÉªt/", cn: "åŒç­åŒå­¦", type: "n." },
        { en: "clean", ph: "/kliËn/", cn: "å¹²å‡€çš„ï¼›æ‰“æ‰«", type: "adj./v." },
        { en: "clear", ph: "/klÉªÉ™/", cn: "æ¸…æ™°çš„ï¼›æ™´æœ—çš„", type: "adj." },
        { en: "clever", ph: "/ËˆklevÉ™/", cn: "èªæ˜çš„", type: "adj." },
        { en: "climb", ph: "/klaÉªm/", cn: "æ”€ç™»ï¼›çˆ¬", type: "v." },
        { en: "clock", ph: "/klÉ’k/", cn: "æ—¶é’Ÿ", type: "n." },
        { en: "clothes", ph: "/klÉ™ÊŠÃ°z/", cn: "è¡£æœ", type: "n." },
        { en: "cloud", ph: "/klaÊŠd/", cn: "äº‘", type: "n." },
        { en: "collect", ph: "/kÉ™Ëˆlekt/", cn: "æ”¶é›†ï¼›æœé›†", type: "v." },
        { en: "color", ph: "/ËˆkÊŒlÉ™/", cn: "é¢œè‰²", type: "n." },
        { en: "comfortable", ph: "/ËˆkÊŒmftÉ™bl/", cn: "èˆ’é€‚çš„", type: "adj." },
        { en: "common", ph: "/ËˆkÉ’mÉ™n/", cn: "æ™®é€šçš„ï¼›å…±åŒçš„", type: "adj." }
    ];

    // --- éŸ³æ•ˆç³»ç»Ÿ ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let soundEnabled = true;

    function playTone(freq, type, duration) {
        if (!soundEnabled) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.08, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + duration);
    }

    const SFX = {
        correct: () => { playTone(500, 'sine', 0.1); setTimeout(() => playTone(800, 'sine', 0.2), 100); },
        wrong: () => { playTone(150, 'sawtooth', 0.3); },
        click: () => { playTone(400, 'triangle', 0.05); },
        win: () => { [400, 500, 600, 800].forEach((f, i) => setTimeout(() => playTone(f, 'sine', 0.2), i*120)); }
    };

    function toggleSound() {
        soundEnabled = !soundEnabled;
        document.getElementById('soundToggleBtn').textContent = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
    }

    function speakCurrentWord() {
        if (!soundEnabled) return;
        const word = activeData[gameState.queue[gameState.currentIndex]].en;
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(word);
        u.lang = 'en-US'; u.rate = 0.85;
        window.speechSynthesis.speak(u);
    }

    let fullWordBank = [];
    let activeData = [];
    let gameState = { level: 1, queue: [], currentIndex: 0, wrongIndices: [], currentWordInputs: [], hintUsedThisWord: false };

    // --- åˆå§‹åŒ–ä¸é€»è¾‘ ---
    window.onload = function() { checkSaveData(); };

    function toggleModal(id) {
        const el = document.getElementById(id);
        if(el.classList.contains('active')) {
            el.classList.remove('active');
        } else {
            el.classList.add('active');
        }
    }

    function checkSaveData() {
        const saved = localStorage.getItem('wordGameSave');
        if (saved) {
            const parsed = JSON.parse(saved);
            if (parsed.activeData && parsed.gameState) {
                document.getElementById('resumeBanner').style.display = 'flex';
                document.getElementById('resumeInfo').textContent = 
                    `Level ${parsed.gameState.level} - è¿›åº¦: ${parsed.gameState.currentIndex}/${parsed.gameState.queue.length}`;
            }
        }
    }

    function resumeGame() {
        const saved = JSON.parse(localStorage.getItem('wordGameSave'));
        activeData = saved.activeData;
        fullWordBank = saved.fullWordBank || activeData;
        gameState = saved.gameState;
        startGameCycle(false);
    }

    function saveProgress() {
        localStorage.setItem('wordGameSave', JSON.stringify({ activeData, gameState, fullWordBank }));
    }

    function clearSave() { localStorage.removeItem('wordGameSave'); }

    function showSection(id) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function goToHome() {
        showSection('setupArea');
        checkSaveData();
        if(window.confettiInterval) clearInterval(window.confettiInterval);
        document.getElementById('confetti-canvas').getContext('2d').clearRect(0,0,window.innerWidth,window.innerHeight);
    }

    function startWithDefault() {
        fullWordBank = JSON.parse(JSON.stringify(defaultData));
        prepareGameSession();
    }

    function handleFileUpload(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const parsed = parseTXT(e.target.result);
            if (parsed.length > 0) {
                fullWordBank = parsed;
                alert(`æˆåŠŸå¯¼å…¥ ${parsed.length} ä¸ªå•è¯ï¼\nç³»ç»Ÿå°†éšæœºæŠ½å– ${Math.min(parsed.length, MAX_WORDS_PER_SESSION)} ä¸ªå¼€å§‹è®­ç»ƒã€‚`);
                prepareGameSession();
            } else {
                alert("æ–‡ä»¶æ ¼å¼æœ‰è¯¯ã€‚");
            }
        };
        reader.readAsText(file, 'UTF-8');
    }

    function prepareGameSession() {
        if (fullWordBank.length <= MAX_WORDS_PER_SESSION) {
            activeData = [...fullWordBank];
        } else {
            let shuffled = [...fullWordBank].sort(() => 0.5 - Math.random());
            activeData = shuffled.slice(0, MAX_WORDS_PER_SESSION);
        }
        initGame();
    }

    function startNewSessionFromBank() { prepareGameSession(); }

    function parseTXT(content) {
        const lines = content.split(/\r?\n/);
        const result = [];
        lines.forEach((line, index) => {
            const tLine = line.trim();
            if (!tLine || (index === 0 && (tLine.includes('è‹±æ–‡') || tLine.includes('å•è¯') || tLine.includes('ability')))) {
                // å¦‚æœç¬¬ä¸€è¡Œæ˜¯abilityä¹Ÿå¯èƒ½æ˜¯æ•°æ®ï¼Œè¿™é‡Œç®€å•çš„é˜²æ­¢headeré€»è¾‘ä¼˜åŒ–
                if(index===0 && (tLine.includes('è‹±æ–‡') || tLine.includes('è¯æ€§'))) return;
            }
            const parts = tLine.split(/,|ï¼Œ/);
            if (parts.length >= 2) {
                result.push({
                    en: parts[0].trim(),
                    ph: parts[1] ? parts[1].trim() : '',
                    cn: parts[2] ? parts[2].trim() : parts[1].trim(),
                    type: parts[3] ? parts[3].trim() : ''
                });
            }
        });
        return result;
    }

    function initGame() {
        gameState.level = 1;
        gameState.wrongIndices = [];
        gameState.queue = activeData.map((_, i) => i);
        gameState.currentIndex = 0;
        clearSave();
        startGameCycle(true);
    }

    function startGameCycle(reset = false) {
        showSection('gameArea');
        document.getElementById('levelBadge').textContent = gameState.level === 1 ? "Level 1" : "Level 2";
        document.getElementById('levelBadge').style.background = gameState.level === 1 ? "#ff7675" : "#a29bfe";
        if (reset) gameState.currentIndex = 0;
        renderWord();
    }

    function renderWord() {
        saveProgress();
        gameState.hintUsedThisWord = false;
        const container = document.getElementById('inputContainer');
        container.innerHTML = '';
        gameState.currentWordInputs = [];

        const wordIdx = gameState.queue[gameState.currentIndex];
        const data = activeData[wordIdx];
        const wordStr = data.en;

        document.getElementById('wordMeaning').textContent = `${data.cn} ${data.type ? '('+data.type+')' : ''}`;
        document.getElementById('phoneticText').textContent = data.ph || "";

        const lettersOnly = wordStr.replace(/[^a-zA-Z]/g, '');
        const hideRatio = gameState.level === 1 ? 0.3 : 0.7;
        let hideCount = Math.ceil(lettersOnly.length * hideRatio);
        if (hideCount < 1 && lettersOnly.length > 0) hideCount = 1;

        let indices = [];
        for (let i=0; i<wordStr.length; i++) if (/[a-zA-Z]/.test(wordStr[i])) indices.push(i);
        indices.sort(() => Math.random() - 0.5);
        const hiddenSet = new Set(indices.slice(0, hideCount));

        for (let i=0; i<wordStr.length; i++) {
            const char = wordStr[i];
            if (char === ' ') {
                const s = document.createElement('div'); s.className = 'char-box space'; container.appendChild(s);
                gameState.currentWordInputs.push({correct: ' ', isInput: false});
            } else if (hiddenSet.has(i)) {
                const inp = document.createElement('input');
                inp.className = 'char-box'; inp.maxLength = 1; inp.dataset.correct = char;
                // ç¦æ­¢æ‰‹æœºè‡ªåŠ¨çº é”™
                inp.setAttribute('autocomplete', 'off');
                inp.setAttribute('autocorrect', 'off');
                inp.setAttribute('autocapitalize', 'off');
                inp.setAttribute('spellcheck', 'false');
                
                inp.oninput = function() { SFX.click(); if(this.value) focusNext(this); };
                inp.onkeydown = function(e) { 
                    if(e.key === 'Backspace' && !this.value) focusPrev(this); 
                    if(e.key === 'Enter') checkCurrentWord();
                };
                inp.onfocus = function() { 
                    setTimeout(() => this.scrollIntoView({behavior:'smooth', block:'center'}), 300); 
                }
                container.appendChild(inp);
                gameState.currentWordInputs.push({correct: char, isInput: true, el: inp});
            } else {
                const d = document.createElement('div'); d.className = 'char-box static'; d.textContent = char;
                container.appendChild(d);
                gameState.currentWordInputs.push({correct: char, isInput: false});
            }
        }
        updateProgress();
        setTimeout(() => { const first = container.querySelector('input'); if(first) first.focus(); }, 100);
    }

    function focusNext(el) { let n = el.nextElementSibling; while(n) { if(n.tagName==='INPUT' && !n.disabled) { n.focus(); return; } n = n.nextElementSibling; } }
    function focusPrev(el) { let p = el.previousElementSibling; while(p) { if(p.tagName==='INPUT' && !p.disabled) { p.focus(); return; } p = p.previousElementSibling; } }
    function updateProgress() { document.getElementById('progressFill').style.width = `${(gameState.currentIndex / gameState.queue.length) * 100}%`; }

    function useHint() {
        const inputs = gameState.currentWordInputs.filter(i => i.isInput && !i.el.disabled);
        let target = inputs.find(i => i.el.value === '') || inputs.find(i => i.el.value.toLowerCase() !== i.correct.toLowerCase());
        if (target) {
            target.el.value = target.correct; target.el.classList.add('hint-revealed'); gameState.hintUsedThisWord = true; SFX.click(); focusNext(target.el);
        }
    }

    function checkCurrentWord() {
        let allCorrect = true;
        gameState.currentWordInputs.forEach(item => {
            if (item.isInput) {
                if (item.el.value.trim().toLowerCase() !== item.correct.toLowerCase()) {
                    allCorrect = false; item.el.classList.add('wrong'); item.el.classList.remove('correct');
                } else {
                    item.el.classList.add('correct'); item.el.classList.remove('wrong');
                }
            }
        });
        const currentIdx = gameState.queue[gameState.currentIndex];
        if (allCorrect) {
            SFX.correct(); speakCurrentWord();
            if (gameState.hintUsedThisWord && gameState.level === 1) if (!gameState.wrongIndices.includes(currentIdx)) gameState.wrongIndices.push(currentIdx);
            setTimeout(() => {
                gameState.currentIndex++;
                if (gameState.currentIndex < gameState.queue.length) renderWord(); else finishLevel();
            }, 1200);
        } else {
            SFX.wrong();
            if (gameState.level === 1) if (!gameState.wrongIndices.includes(currentIdx)) gameState.wrongIndices.push(currentIdx);
        }
    }

    function finishLevel() {
        clearSave();
        showSection('resultArea');
        const total = gameState.queue.length;
        const wrongCount = gameState.wrongIndices.length;
        const score = Math.round(((total - wrongCount) / total) * 100);
        
        const scoreDisplay = document.getElementById('scoreDisplay');
        const fb = document.getElementById('feedbackText');
        const nextBtn = document.getElementById('nextLevelBtn');
        const restartBtn = document.getElementById('restartBtn');
        const wrongArea = document.getElementById('wrongListContainer');
        
        document.querySelector('.score-val').textContent = score;

        if (score === 100) {
            SFX.win(); startConfetti();
            scoreDisplay.style.background = "#2ecc71"; 
            scoreDisplay.style.borderColor = "#2ecc71";
            fb.innerHTML = "ğŸ‰ <strong style='font-size:1.4rem'>Perfect!</strong><br>å…¨éƒ¨æ­£ç¡®ï¼ä½ çš„è¯æ±‡é‡éå¸¸æ‰å®ï¼";
            wrongArea.style.display = 'none'; nextBtn.style.display = 'none'; restartBtn.style.display = 'inline-block';
        } else {
            scoreDisplay.style.background = "#fdcb6e"; 
            scoreDisplay.style.borderColor = "#fdcb6e";
            wrongArea.style.display = 'block';
            let html = gameState.wrongIndices.map(i => {
                const w = activeData[i]; return `<div class="wrong-item"><span class="wrong-en">${w.en}</span><span class="wrong-cn">${w.cn}</span></div>`;
            }).join('');
            document.getElementById('wrongListItems').innerHTML = html;
            if (gameState.level === 1) {
                fb.innerHTML = `æœ¬æ¬¡å¾—åˆ† <strong>${score}</strong> åˆ†ã€‚<br>é”™é¢˜å·²åŠ å…¥ä¸‹æ–¹åˆ—è¡¨ï¼Œå‡†å¤‡å¥½æŒ‘æˆ˜ç¬¬äºŒå…³äº†å—ï¼Ÿ`;
                nextBtn.style.display = 'inline-block'; restartBtn.style.display = 'none';
            } else {
                fb.innerHTML = `Level 2 å®Œæˆï¼<br>ç»è¿‡é«˜å¼ºåº¦æ‹¼å†™è®­ç»ƒï¼Œè¿™äº›å•è¯ä½ å·²ç»æŒæ¡äº†ï¼`;
                nextBtn.style.display = 'none'; restartBtn.style.display = 'inline-block';
            }
        }
    }

    function startLevel2() {
        gameState.level = 2; gameState.queue = [...gameState.wrongIndices]; gameState.currentIndex = 0;
        if(gameState.queue.length === 0) { alert("æ²¡æœ‰é”™é¢˜ï¼"); return; }
        startGameCycle(true);
    }

    function exportWrongWords() {
        if (gameState.wrongIndices.length === 0) return;
        let content = "è‹±æ–‡å•è¯,éŸ³æ ‡,ä¸­æ–‡é‡Šä¹‰,è¯æ€§\n";
        gameState.wrongIndices.forEach(idx => { const w = activeData[idx]; content += `${w.en},${w.ph},${w.cn},${w.type}\n`; });
        const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `review_words_${new Date().toISOString().slice(0,10)}.txt`; a.click();
    }

    function startConfetti() {
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        const pieces = Array.from({length:120}, () => ({
            x: Math.random()*canvas.width, y: Math.random()*canvas.height-canvas.height,
            w: Math.random()*10+5, h: Math.random()*10+5, c: ['#f1c40f','#e74c3c','#3498db','#2ecc71'].at(Math.floor(Math.random()*4)), v: Math.random()*3+2
        }));
        window.confettiInterval = setInterval(() => {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            pieces.forEach(p => {
                p.y += p.v; p.x += Math.sin(p.y*0.01); ctx.fillStyle = p.c; ctx.fillRect(p.x, p.y, p.w, p.h);
                if(p.y > canvas.height) p.y = -20;
            });
        }, 16);
    }
    window.onresize = () => { document.getElementById('confetti-canvas').width = window.innerWidth; };
</script>
</body>
</html>