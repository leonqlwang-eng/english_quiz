<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‹±è¯­å•è¯å¤§é—¯å…³ V2.1</title>
    <style>
        :root {
            --primary-color: #4facfe;
            --secondary-color: #00f2fe;
            --accent-color: #ff9a9e;
            --text-color: #2d3436;
            --bg-gradient: linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --input-border: #dfe6e9;
            --success: #2ecc71;
            --error: #e74c3c;
            --warn: #f1c40f;
        }

        body {
            font-family: 'Comic Sans MS', 'Chalkboard SE', 'Microsoft YaHei', sans-serif;
            background: var(--bg-gradient);
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-color);
            overflow-x: hidden;
        }

        /* ç²’å­ç”»å¸ƒ */
        #confetti-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999;
        }

        .container {
            width: 90%;
            max-width: 600px;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
            padding: 2rem;
            text-align: center;
            position: relative;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            z-index: 10;
        }

        h1 { color: #6c5ce7; margin: 0 0 0.5rem 0; }
        p { color: #636e72; margin-bottom: 1.5rem; }

        /* æŒ‰é’®é€šç”¨æ ·å¼ */
        .btn {
            background: linear-gradient(to right, #6c5ce7, #a29bfe);
            color: white; border: none; padding: 12px 25px; font-size: 1rem; border-radius: 25px;
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; font-family: inherit; margin: 8px;
            display: inline-flex; align-items: center; justify-content: center; gap: 5px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(108, 92, 231, 0.4); }
        .btn:active { transform: translateY(0); }
        
        .btn-outline { background: transparent; border: 2px solid #6c5ce7; color: #6c5ce7; }
        .btn-outline:hover { background: #6c5ce7; color: white; }
        .btn-small { padding: 5px 15px; font-size: 0.85rem; height: 32px; }
        .btn-icon { background: none; color: #6c5ce7; font-size: 1.5rem; padding: 5px; border: 2px solid transparent; box-shadow: none; }
        .btn-icon:hover { background: #f0f0f0; transform: scale(1.1); border-color: #ddd; }

        /* é¡¶éƒ¨å·¥å…·æ  */
        .game-toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .level-badge { background: #ff7675; color: white; padding: 5px 15px; border-radius: 15px; font-size: 0.9rem; font-weight: bold; }

        /* è¿›åº¦æ¡ */
        .progress-bar { width: 100%; height: 8px; background: #dfe6e9; border-radius: 4px; margin-bottom: 1.5rem; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); width: 0%; transition: width 0.3s ease; }

        /* å•è¯åŒºåŸŸ */
        .word-meaning { font-size: 1.6rem; font-weight: bold; color: #2d3436; margin: 10px 0; }
        .word-phonetic { color: #636e72; font-size: 1.1rem; font-family: Arial, sans-serif; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }

        /* è¾“å…¥æ¡† */
        .input-container { display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; margin: 2rem 0; min-height: 60px; }
        .char-box {
            width: 45px; height: 55px; font-size: 1.8rem; text-align: center; border: 2px solid var(--input-border);
            border-radius: 10px; background: white; text-transform: lowercase; transition: all 0.2s; caret-color: var(--primary-color);
        }
        .char-box:focus { border-color: var(--primary-color); outline: none; transform: scale(1.1); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .char-box.static { background-color: #f1f2f6; border: none; font-weight: bold; line-height: 55px; user-select: none; }
        .char-box.space { width: 15px; border: none; background: transparent; }
        .char-box.correct { border-color: var(--success); background-color: #eafff2; color: var(--success); }
        .char-box.wrong { border-color: var(--error); background-color: #fff0f0; color: var(--error); animation: shake 0.4s; }
        .char-box.hint-revealed { border-color: var(--warn); color: #d35400; background: #fff8e1; }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* åŒºåŸŸæ§åˆ¶ */
        .section { display: none; animation: fadeIn 0.4s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* èµ·å§‹é¡µ */
        .file-upload-wrapper {
            margin: 20px 0; border: 2px dashed #b2bec3; padding: 30px; border-radius: 15px; background: #f9f9f9; cursor: pointer; transition: background 0.2s;
        }
        .file-upload-wrapper:hover { background: #f0f4f8; border-color: var(--primary-color); }
        .resume-banner {
            background: #dff9fb; color: #2c3e50; padding: 15px; border-radius: 10px; margin-bottom: 20px;
            border-left: 5px solid #00cec9; text-align: left; display: flex; justify-content: space-between; align-items: center;
        }
        
        /* æ¨¡æ€æ¡† (Release Note) */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;
        }
        .modal-overlay.active { display: flex; animation: fadeIn 0.3s; }
        .modal-box {
            background: white; width: 85%; max-width: 500px; padding: 25px; border-radius: 15px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align: left; max-height: 80vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .modal-title { font-size: 1.2rem; font-weight: bold; color: #2d3436; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999; }
        .release-item { margin-bottom: 15px; }
        .release-ver { font-weight: bold; color: #6c5ce7; font-size: 0.95rem; }
        .release-date { font-size: 0.8rem; color: #b2bec3; margin-left: 10px; }
        .release-content { margin-top: 5px; font-size: 0.9rem; color: #636e72; line-height: 1.5; padding-left: 10px; }
        .release-content li { margin-bottom: 4px; }

        /* ç»“ç®—é¡µå…ƒç´  */
        .score-circle {
            width: 130px; height: 130px; border-radius: 50%; background: #fdcb6e; color: white;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            margin: 0 auto 1.5rem; box-shadow: 0 0 25px rgba(253, 203, 110, 0.6); border: 5px solid white;
        }
        .score-val { font-size: 3rem; font-weight: 800; line-height: 1; }
        .score-label { font-size: 0.9rem; opacity: 0.9; }
        .wrong-list { text-align: left; background: #fff5f5; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; max-height: 250px; overflow-y: auto; border: 1px solid #ffccc7; }
        .wrong-item { border-bottom: 1px dashed #ffccc7; padding: 8px 0; color: #c0392b; display: flex; justify-content: space-between; }
        .wrong-item:last-child { border-bottom: none; }

        @media (max-width: 480px) {
            .char-box { width: 34px; height: 45px; font-size: 1.4rem; }
            .container { padding: 1.5rem; width: 92%; }
        }
    </style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>

<div class="container">
    
    <!-- 1. èµ·å§‹é¡µ -->
    <div id="setupArea" class="section active">
        <h1>Welcome!</h1>
        <p>è‹±è¯­å•è¯å¤§é—¯å…³</p>
        
        <!-- æ¢å¤å­˜æ¡£æç¤º -->
        <div id="resumeBanner" class="resume-banner" style="display:none;">
            <div>
                <strong>å‘ç°æœªå®Œæˆçš„è¿›åº¦</strong><br>
                <small id="resumeInfo">Level 1 - 5/10 words</small>
            </div>
            <button class="btn btn-small" onclick="resumeGame()">ç»§ç»­</button>
        </div>

        <button class="btn" onclick="startWithDefault()">ğŸš€ ä½¿ç”¨é»˜è®¤è¯åº“</button>
        
        <div class="file-upload-wrapper" onclick="document.getElementById('fileInput').click()">
            <div style="font-size:2rem;">ğŸ“‚</div>
            <div>ç‚¹å‡»ä¸Šä¼ è‡ªå®šä¹‰é¢˜åº“ (.txt)</div>
            <div style="font-size:0.8rem; color:#b2bec3; margin-top:5px;">ç³»ç»Ÿå°†éšæœºæŠ½å– 10 ä¸ªå•è¯è¿›è¡Œè®­ç»ƒ</div>
            <input type="file" id="fileInput" accept=".txt,.csv" onchange="handleFileUpload(this)" style="display:none;">
        </div>

        <div style="margin-top:20px;">
            <button class="btn btn-outline btn-small" onclick="toggleModal('releaseModal')">ğŸ“œ ç‰ˆæœ¬è®°å½• (Release Notes)</button>
        </div>
    </div>

    <!-- 2. æ¸¸æˆä¸»ç•Œé¢ -->
    <div id="gameArea" class="section">
        <div class="game-toolbar">
            <div id="levelBadge" class="level-badge">Level 1</div>
            <button class="btn btn-icon" onclick="toggleSound()" title="éŸ³æ•ˆå¼€å…³" id="soundToggleBtn">ğŸ”Š</button>
        </div>
        
        <div class="progress-bar">
            <div id="progressFill" class="progress-fill"></div>
        </div>

        <div id="wordMeaning" class="word-meaning">ä¸­æ–‡é‡Šä¹‰</div>
        <div id="wordPhonetic" class="word-phonetic" onclick="speakCurrentWord()">
            <span id="phoneticText">/éŸ³æ ‡/</span> ğŸ”Š
        </div>

        <div id="inputContainer" class="input-container">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>

        <div style="display:flex; justify-content:center; gap:20px;">
            <button class="btn btn-outline" onclick="useHint()" title="æç¤ºä¸€ä¸ªå­—æ¯ (è®°ä¸ºéœ€å¤ä¹ )">ğŸ’¡ æç¤º</button>
            <button id="submitBtn" class="btn" onclick="checkCurrentWord()">æäº¤ / Next</button>
        </div>
    </div>

    <!-- 3. ç»“ç®—é¡µ -->
    <div id="resultArea" class="section">
        <div class="score-circle" id="scoreDisplay">
            <div class="score-val">100</div>
            <div class="score-label">å¾—åˆ†</div>
        </div>
        <div id="feedbackText" style="margin-bottom:1.5rem; font-size:1.1rem; line-height:1.6;"></div>
        
        <div id="wrongListContainer" class="wrong-list" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <strong>é”™é¢˜æœ¬ / é‡ç‚¹å¤ä¹ ï¼š</strong>
                <button class="btn btn-small btn-outline" onclick="exportWrongWords()">â¬‡ï¸ å¯¼å‡º</button>
            </div>
            <div id="wrongListItems"></div>
        </div>

        <div style="display:flex; justify-content:center; flex-wrap:wrap;">
            <button id="nextLevelBtn" class="btn" onclick="startLevel2()">è¿›å…¥ç¬¬äºŒå…³ (Hard)</button>
            <button id="restartBtn" class="btn" onclick="startNewSessionFromBank()" style="display:none;">ğŸ” æ¢ä¸€ç»„å•è¯å†ç»ƒ</button>
            <button class="btn btn-outline" onclick="goToHome()">ğŸ  è¿”å›é¦–é¡µ</button>
        </div>
    </div>
</div>

<!-- Release Note Modal -->
<div id="releaseModal" class="modal-overlay" onclick="if(event.target===this) toggleModal('releaseModal')">
    <div class="modal-box">
        <div class="modal-header">
            <div class="modal-title">ç‰ˆæœ¬æ›´æ–°è®°å½•</div>
            <button class="close-btn" onclick="toggleModal('releaseModal')">&times;</button>
        </div>
        
        <div class="release-item">
            <span class="release-ver">V2.1</span><span class="release-date">å½“å‰ç‰ˆæœ¬</span>
            <ul class="release-content">
                <li>âœ¨ <strong>æ™ºèƒ½åˆ†æ‰¹ï¼š</strong> æ— è®ºä¸Šä¼ å¤šå°‘å•è¯ï¼Œæ¯æ¬¡è®­ç»ƒåªéšæœºæŠ½å– 10 ä¸ªï¼Œå‡è½»è®°å¿†è´Ÿæ‹…ã€‚</li>
                <li>ğŸ“ <strong>ç‰ˆæœ¬è®°å½•ï¼š</strong> å¢åŠ  Release Note æŸ¥çœ‹å…¥å£ã€‚</li>
                <li>ğŸ”„ <strong>å¾ªç¯ç»ƒä¹ ï¼š</strong> ç»“æŸåå¯é€‰æ‹©â€œæ¢ä¸€ç»„å•è¯â€ç»§ç»­æŒ‘æˆ˜ã€‚</li>
            </ul>
        </div>

        <div class="release-item">
            <span class="release-ver">V2.0</span><span class="release-date">2023-10</span>
            <ul class="release-content">
                <li>ğŸ”Š <strong>è¯­éŸ³åŠŸèƒ½ï¼š</strong> æ”¯æŒå•è¯çœŸäººæœ—è¯» (TTS) ä¸éŸ³æ•ˆåé¦ˆã€‚</li>
                <li>ğŸ’¡ <strong>æç¤ºç³»ç»Ÿï¼š</strong> å¢åŠ â€œæ…§çœ¼â€åŠŸèƒ½ï¼Œå¯æ¶ˆè€—ç§¯åˆ†æŸ¥çœ‹æç¤ºã€‚</li>
                <li>ğŸ’¾ <strong>è‡ªåŠ¨å­˜æ¡£ï¼š</strong> æ„å¤–å…³é—­æµè§ˆå™¨å¯æ¢å¤è¿›åº¦ã€‚</li>
                <li>ğŸ“¥ <strong>é”™é¢˜å¯¼å‡ºï¼š</strong> æ”¯æŒå°†é”™é¢˜ä¿å­˜ä¸º .txt æ–‡ä»¶ã€‚</li>
            </ul>
        </div>

        <div class="release-item">
            <span class="release-ver">V1.0</span><span class="release-date">2023-09</span>
            <ul class="release-content">
                <li>ğŸ® åŸºç¡€é—¯å…³æ¨¡å¼ï¼ˆLevel 1 å¡«ç©º30%ï¼ŒLevel 2 å¡«ç©º70%ï¼‰ã€‚</li>
                <li>ğŸ“± ç§»åŠ¨ç«¯ä¸æ¡Œé¢ç«¯è‡ªé€‚åº”å¸ƒå±€ã€‚</li>
            </ul>
        </div>
    </div>
</div>

<script>
    // --- é…ç½® ---
    const MAX_WORDS_PER_SESSION = 10; // æ¯æ¬¡ç»ƒä¹ çš„æœ€å¤§å•è¯æ•°

    // --- éŸ³æ•ˆç³»ç»Ÿ ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let soundEnabled = true;

    function playTone(freq, type, duration) {
        if (!soundEnabled) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + duration);
    }

    const SFX = {
        correct: () => { playTone(600, 'sine', 0.1); setTimeout(() => playTone(800, 'sine', 0.2), 100); },
        wrong: () => { playTone(150, 'sawtooth', 0.3); },
        click: () => { playTone(400, 'triangle', 0.05); },
        win: () => { [400, 500, 600, 800].forEach((f, i) => setTimeout(() => playTone(f, 'sine', 0.2), i*100)); }
    };

    function toggleSound() {
        soundEnabled = !soundEnabled;
        document.getElementById('soundToggleBtn').textContent = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
    }

    function speakCurrentWord() {
        if (!soundEnabled) return;
        const word = activeData[gameState.queue[gameState.currentIndex]].en;
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(word);
        u.lang = 'en-US'; u.rate = 0.9;
        window.speechSynthesis.speak(u);
    }

    // --- æ•°æ® ---
    const defaultData = [
        { en: "weigh", ph: "/weÉª/", cn: "æœ‰â€¦â€¦é‡ï¼›ç§°é‡", type: "v." },
        { en: "kilogram", ph: "/ËˆkÉªlÉ™É¡rÃ¦m/", cn: "åƒå…‹ï¼›å…¬æ–¤", type: "n." },
        { en: "centimetre", ph: "/ËˆsentÉªmiËtÉ™/", cn: "å˜ç±³", type: "n." },
        { en: "taller", ph: "/ËˆtÉ”ËlÉ™/", cn: "æ›´é«˜çš„", type: "adj." },
        { en: "fan", ph: "/fÃ¦n/", cn: "è¿·ï¼›ç‹‚çƒ­çˆ±å¥½è€…", type: "n." },
        { en: "theatre", ph: "/ËˆÎ¸ÉªÉ™tÉ™/", cn: "å‰§åœºï¼›å‰§é™¢", type: "n." },
        { en: "fantastic", ph: "/fÃ¦nËˆtÃ¦stÉªk/", cn: "æå¥½çš„", type: "adj." },
        { en: "go fishing", ph: "/É¡É™ÊŠ ËˆfÉªÊƒÉªÅ‹/", cn: "å»é’“é±¼", type: "è¯ç»„" },
        { en: "dinosaur", ph: "/ËˆdaÉªnÉ™sÉ”Ë/", cn: "æé¾™", type: "n." },
        { en: "meter", ph: "/ËˆmiËtÉ™/", cn: "ç±³", type: "n." },
        { en: "heavy", ph: "/Ëˆhevi/", cn: "é‡çš„", type: "adj." }
    ];

    let fullWordBank = []; // å­˜å‚¨æ‰€æœ‰ä¸Šä¼ çš„å•è¯
    let activeData = [];   // æœ¬æ¬¡è®­ç»ƒé€‰ä¸­çš„å•è¯

    // --- çŠ¶æ€ ---
    let gameState = {
        level: 1, queue: [], currentIndex: 0, wrongIndices: [], currentWordInputs: [], hintUsedThisWord: false
    };

    // --- åˆå§‹åŒ–ä¸é€»è¾‘ ---
    window.onload = function() { checkSaveData(); };

    function toggleModal(id) {
        const el = document.getElementById(id);
        el.classList.toggle('active');
    }

    function checkSaveData() {
        const saved = localStorage.getItem('wordGameSave');
        if (saved) {
            const parsed = JSON.parse(saved);
            if (parsed.activeData && parsed.gameState) {
                document.getElementById('resumeBanner').style.display = 'flex';
                document.getElementById('resumeInfo').textContent = 
                    `Level ${parsed.gameState.level} - è¿›åº¦: ${parsed.gameState.currentIndex}/${parsed.gameState.queue.length}`;
            }
        }
    }

    function resumeGame() {
        const saved = JSON.parse(localStorage.getItem('wordGameSave'));
        activeData = saved.activeData;
        fullWordBank = saved.fullWordBank || activeData; // å…¼å®¹æ—§ç‰ˆ
        gameState = saved.gameState;
        startGameCycle(false);
    }

    function saveProgress() {
        localStorage.setItem('wordGameSave', JSON.stringify({ activeData, gameState, fullWordBank }));
    }

    function clearSave() { localStorage.removeItem('wordGameSave'); }

    function showSection(id) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function goToHome() {
        showSection('setupArea');
        checkSaveData();
        if(window.confettiInterval) clearInterval(window.confettiInterval);
        const canvas = document.getElementById('confetti-canvas');
        canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
    }

    function startWithDefault() {
        fullWordBank = JSON.parse(JSON.stringify(defaultData));
        prepareGameSession();
    }

    function handleFileUpload(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const parsed = parseTXT(e.target.result);
            if (parsed.length > 0) {
                fullWordBank = parsed;
                alert(`æˆåŠŸå¯¼å…¥ ${parsed.length} ä¸ªå•è¯ï¼\nç³»ç»Ÿå°†éšæœºæŠ½å– ${Math.min(parsed.length, MAX_WORDS_PER_SESSION)} ä¸ªå¼€å§‹è®­ç»ƒã€‚`);
                prepareGameSession();
            } else {
                alert("æ–‡ä»¶æ ¼å¼æœ‰è¯¯ã€‚");
            }
        };
        reader.readAsText(file, 'UTF-8');
    }

    // ä»æ€»é¢˜åº“ä¸­éšæœºæŠ½å–Nä¸ª
    function prepareGameSession() {
        if (fullWordBank.length <= MAX_WORDS_PER_SESSION) {
            activeData = [...fullWordBank];
        } else {
            // æ´—ç‰Œç®—æ³•
            let shuffled = [...fullWordBank].sort(() => 0.5 - Math.random());
            activeData = shuffled.slice(0, MAX_WORDS_PER_SESSION);
        }
        initGame();
    }

    function startNewSessionFromBank() {
        prepareGameSession();
    }

    function parseTXT(content) {
        const lines = content.split(/\r?\n/);
        const result = [];
        lines.forEach((line, index) => {
            const tLine = line.trim();
            if (!tLine || (index === 0 && (tLine.includes('è‹±æ–‡') || tLine.includes('å•è¯')))) return;
            const parts = tLine.split(/,|ï¼Œ/);
            if (parts.length >= 2) {
                result.push({
                    en: parts[0].trim(),
                    ph: parts[1] ? parts[1].trim() : '',
                    cn: parts[2] ? parts[2].trim() : parts[1].trim(),
                    type: parts[3] ? parts[3].trim() : ''
                });
            }
        });
        return result;
    }

    // --- æ¸¸æˆæµç¨‹ ---
    function initGame() {
        gameState.level = 1;
        gameState.wrongIndices = [];
        gameState.queue = activeData.map((_, i) => i);
        gameState.currentIndex = 0;
        clearSave();
        startGameCycle(true);
    }

    function startGameCycle(reset = false) {
        showSection('gameArea');
        document.getElementById('levelBadge').textContent = gameState.level === 1 ? "Level 1 (Easy)" : "Level 2 (Hard)";
        document.getElementById('levelBadge').style.background = gameState.level === 1 ? "#ff7675" : "#a29bfe";
        if (reset) gameState.currentIndex = 0;
        renderWord();
    }

    function renderWord() {
        saveProgress();
        gameState.hintUsedThisWord = false;
        const container = document.getElementById('inputContainer');
        container.innerHTML = '';
        gameState.currentWordInputs = [];

        const wordIdx = gameState.queue[gameState.currentIndex];
        const data = activeData[wordIdx];
        const wordStr = data.en;

        document.getElementById('wordMeaning').textContent = `${data.cn} ${data.type ? '('+data.type+')' : ''}`;
        document.getElementById('phoneticText').textContent = data.ph || "";

        const lettersOnly = wordStr.replace(/[^a-zA-Z]/g, '');
        const hideRatio = gameState.level === 1 ? 0.3 : 0.7;
        let hideCount = Math.ceil(lettersOnly.length * hideRatio);
        if (hideCount < 1 && lettersOnly.length > 0) hideCount = 1;

        let indices = [];
        for (let i=0; i<wordStr.length; i++) if (/[a-zA-Z]/.test(wordStr[i])) indices.push(i);
        indices.sort(() => Math.random() - 0.5);
        const hiddenSet = new Set(indices.slice(0, hideCount));

        for (let i=0; i<wordStr.length; i++) {
            const char = wordStr[i];
            if (char === ' ') {
                const s = document.createElement('div'); s.className = 'char-box space'; container.appendChild(s);
                gameState.currentWordInputs.push({correct: ' ', isInput: false});
            } else if (hiddenSet.has(i)) {
                const inp = document.createElement('input');
                inp.className = 'char-box'; inp.maxLength = 1; inp.dataset.correct = char;
                inp.oninput = function() { SFX.click(); if(this.value) focusNext(this); };
                inp.onkeydown = function(e) { 
                    if(e.key === 'Backspace' && !this.value) focusPrev(this); 
                    if(e.key === 'Enter') checkCurrentWord();
                };
                inp.onfocus = function() { setTimeout(() => this.scrollIntoView({behavior:'smooth', block:'center'}), 300); }
                container.appendChild(inp);
                gameState.currentWordInputs.push({correct: char, isInput: true, el: inp});
            } else {
                const d = document.createElement('div'); d.className = 'char-box static'; d.textContent = char;
                container.appendChild(d);
                gameState.currentWordInputs.push({correct: char, isInput: false});
            }
        }
        updateProgress();
        setTimeout(() => { const first = container.querySelector('input'); if(first) first.focus(); }, 100);
    }

    function focusNext(el) { let n = el.nextElementSibling; while(n) { if(n.tagName==='INPUT' && !n.disabled) { n.focus(); return; } n = n.nextElementSibling; } }
    function focusPrev(el) { let p = el.previousElementSibling; while(p) { if(p.tagName==='INPUT' && !p.disabled) { p.focus(); return; } p = p.previousElementSibling; } }
    function updateProgress() { document.getElementById('progressFill').style.width = `${(gameState.currentIndex / gameState.queue.length) * 100}%`; }

    function useHint() {
        const inputs = gameState.currentWordInputs.filter(i => i.isInput && !i.el.disabled);
        let target = inputs.find(i => i.el.value === '') || inputs.find(i => i.el.value.toLowerCase() !== i.correct.toLowerCase());
        if (target) {
            target.el.value = target.correct; target.el.classList.add('hint-revealed'); gameState.hintUsedThisWord = true; SFX.click(); focusNext(target.el);
        }
    }

    function checkCurrentWord() {
        let allCorrect = true;
        gameState.currentWordInputs.forEach(item => {
            if (item.isInput) {
                if (item.el.value.trim().toLowerCase() !== item.correct.toLowerCase()) {
                    allCorrect = false; item.el.classList.add('wrong'); item.el.classList.remove('correct');
                } else {
                    item.el.classList.add('correct'); item.el.classList.remove('wrong');
                }
            }
        });
        const currentIdx = gameState.queue[gameState.currentIndex];
        if (allCorrect) {
            SFX.correct(); speakCurrentWord();
            if (gameState.hintUsedThisWord && gameState.level === 1) if (!gameState.wrongIndices.includes(currentIdx)) gameState.wrongIndices.push(currentIdx);
            setTimeout(() => {
                gameState.currentIndex++;
                if (gameState.currentIndex < gameState.queue.length) renderWord(); else finishLevel();
            }, 1200);
        } else {
            SFX.wrong();
            if (gameState.level === 1) if (!gameState.wrongIndices.includes(currentIdx)) gameState.wrongIndices.push(currentIdx);
        }
    }

    function finishLevel() {
        clearSave();
        showSection('resultArea');
        const total = gameState.queue.length;
        const wrongCount = gameState.wrongIndices.length;
        const score = Math.round(((total - wrongCount) / total) * 100);
        
        const scoreDisplay = document.getElementById('scoreDisplay');
        const fb = document.getElementById('feedbackText');
        const nextBtn = document.getElementById('nextLevelBtn');
        const restartBtn = document.getElementById('restartBtn');
        const wrongArea = document.getElementById('wrongListContainer');
        
        document.querySelector('.score-val').textContent = score;

        if (score === 100) {
            SFX.win(); startConfetti();
            scoreDisplay.style.background = "#2ecc71"; fb.innerHTML = "ğŸ‰ Perfect! <br>å…¨éƒ¨æ­£ç¡®ï¼";
            wrongArea.style.display = 'none'; nextBtn.style.display = 'none'; restartBtn.style.display = 'inline-block';
        } else {
            scoreDisplay.style.background = "#fdcb6e"; wrongArea.style.display = 'block';
            let html = gameState.wrongIndices.map(i => {
                const w = activeData[i]; return `<div class="wrong-item"><span>${w.en}</span><span style="color:#636e72;">${w.cn}</span></div>`;
            }).join('');
            document.getElementById('wrongListItems').innerHTML = html;
            if (gameState.level === 1) {
                fb.innerHTML = `æœ¬æ¬¡å¾—åˆ† ${score} åˆ†ã€‚<br>å‡†å¤‡å¥½è¿›å…¥ç¬¬äºŒå…³äº†å—ï¼Ÿ`;
                nextBtn.style.display = 'inline-block'; restartBtn.style.display = 'none';
            } else {
                fb.innerHTML = `Level 2 å®Œæˆï¼<br>è¾›è‹¦äº†ï¼`;
                nextBtn.style.display = 'none'; restartBtn.style.display = 'inline-block';
            }
        }
    }

    function startLevel2() {
        gameState.level = 2; gameState.queue = [...gameState.wrongIndices]; gameState.currentIndex = 0;
        if(gameState.queue.length === 0) { alert("æ²¡æœ‰é”™é¢˜ï¼"); return; }
        startGameCycle(true);
    }

    function exportWrongWords() {
        if (gameState.wrongIndices.length === 0) return;
        let content = "è‹±æ–‡å•è¯,éŸ³æ ‡,ä¸­æ–‡é‡Šä¹‰,è¯æ€§\n";
        gameState.wrongIndices.forEach(idx => { const w = activeData[idx]; content += `${w.en},${w.ph},${w.cn},${w.type}\n`; });
        const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `wrong_words.txt`; a.click();
    }

    // --- å½©å¸¦ç‰¹æ•ˆ ---
    function startConfetti() {
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        const pieces = Array.from({length:100}, () => ({
            x: Math.random()*canvas.width, y: Math.random()*canvas.height-canvas.height,
            w: Math.random()*10+5, h: Math.random()*10+5, c: ['#f1c40f','#e74c3c','#3498db','#2ecc71'].at(Math.floor(Math.random()*4)), v: Math.random()*3+2
        }));
        window.confettiInterval = setInterval(() => {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            pieces.forEach(p => {
                p.y += p.v; p.x += Math.sin(p.y*0.01); ctx.fillStyle = p.c; ctx.fillRect(p.x, p.y, p.w, p.h);
                if(p.y > canvas.height) p.y = -20;
            });
        }, 16);
    }
    window.onresize = () => { document.getElementById('confetti-canvas').width = window.innerWidth; };
</script>
</body>
</html>