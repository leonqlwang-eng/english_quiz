<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- SEO & Social Sharing -->
    <title>è‹±è¯­å•è¯å¤§é—¯å…³ V2.3 | éš¾åº¦åˆ†çº§ç‰ˆ</title>
    <meta name="description" content="è¶£å‘³è‹±è¯­å•è¯å¡«ç©ºæ¸¸æˆï¼Œæ”¯æŒç®€å•ã€å›°éš¾ã€åœ°ç‹±ä¸‰ç§éš¾åº¦ï¼Œæ™ºèƒ½é”™é¢˜å¤ä¹ ã€‚">
    
    <!-- Mobile App Experience -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#e0c3fc">
    <link rel="apple-touch-icon" href="https://ui-avatars.com/api/?name=En&background=6c5ce7&color=fff&rounded=true">

    <style>
        :root {
            --primary-color: #6c5ce7;
            --secondary-color: #a29bfe;
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --card-bg: rgba(255, 255, 255, 0.96);
            --text-color: #2d3436;
            --success: #00b894;
            --error: #d63031;
            --warn: #fdcb6e;
            --diff-easy: #00b894;
            --diff-hard: #e17055;
            --diff-hell: #6c5ce7;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: var(--bg-gradient);
            margin: 0; min-height: 100vh; display: flex; justify-content: center; align-items: center;
            color: var(--text-color); overflow-x: hidden; -webkit-tap-highlight-color: transparent;
        }

        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; }

        .container {
            width: 90%; max-width: 600px; background: var(--card-bg); border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.08); padding: 2.5rem 2rem; text-align: center;
            position: relative; backdrop-filter: blur(12px); z-index: 10;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        h1 { color: var(--primary-color); margin: 0 0 0.5rem 0; font-size: 1.8rem; letter-spacing: -0.5px; }
        p { color: #636e72; margin-bottom: 1.5rem; font-size: 0.95rem; }

        /* éš¾åº¦é€‰æ‹©å™¨ */
        .diff-selector {
            display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; background: #f1f2f6;
            padding: 5px; border-radius: 30px; position: relative;
        }
        .diff-btn {
            flex: 1; padding: 10px 0; cursor: pointer; border-radius: 25px; font-weight: 600; font-size: 0.9rem;
            color: #b2bec3; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; line-height: 1.2;
        }
        .diff-btn small { font-size: 0.7rem; font-weight: normal; opacity: 0.8; }
        
        /* é€‰ä¸­çŠ¶æ€ */
        .diff-btn.active[data-val="easy"] { background: white; color: var(--diff-easy); box-shadow: 0 2px 10px rgba(0,184,148,0.2); }
        .diff-btn.active[data-val="hard"] { background: white; color: var(--diff-hard); box-shadow: 0 2px 10px rgba(225,112,85,0.2); }
        .diff-btn.active[data-val="hell"] { background: white; color: var(--diff-hell); box-shadow: 0 2px 10px rgba(108,92,231,0.2); }

        /* æŒ‰é’® */
        .btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white; border: none; padding: 14px 28px; font-size: 1rem; border-radius: 30px;
            cursor: pointer; transition: all 0.2s; font-weight: 600; margin: 8px;
            display: inline-flex; align-items: center; justify-content: center; gap: 6px;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(108, 92, 231, 0.4); }
        .btn:active { transform: scale(0.98); }
        .btn-outline { background: transparent; border: 2px solid var(--primary-color); color: var(--primary-color); box-shadow: none; }
        .btn-outline:hover { background: var(--primary-color); color: white; }
        .btn-small { padding: 6px 16px; font-size: 0.85rem; }
        .btn-icon { background: rgba(0,0,0,0.05); color: var(--primary-color); font-size: 1.4rem; padding: 8px; border-radius: 50%; width: 40px; height: 40px; box-shadow: none; }

        /* æ¸¸æˆç•Œé¢ */
        .game-toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .level-badge { color: white; padding: 6px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; text-transform: uppercase; transition: background 0.3s; }

        .progress-bar { width: 100%; height: 6px; background: #f0f2f5; border-radius: 3px; margin-bottom: 2rem; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #4facfe, #00f2fe); width: 0%; transition: width 0.4s ease; }

        .word-meaning { font-size: 1.8rem; font-weight: 700; color: #2d3436; margin: 15px 0 5px; }
        .word-phonetic { color: #b2bec3; font-size: 1.1rem; font-family: Arial, sans-serif; cursor: pointer; display: flex; justify-content: center; gap: 8px; }
        .word-phonetic:hover { color: var(--primary-color); }

        .input-container { display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; margin: 2.5rem 0; min-height: 60px; }
        .char-box {
            width: 48px; height: 58px; font-size: 1.8rem; text-align: center; border: 2px solid #e1e4e8;
            border-radius: 12px; background: white; color: #2d3436; transition: all 0.2s; font-weight: 600;
        }
        .char-box:focus { border-color: var(--primary-color); transform: translateY(-4px); outline: none; }
        .char-box.static { background-color: #f8f9fa; border-color: transparent; color: #636e72; user-select: none; }
        .char-box.space { width: 20px; border: none; background: transparent; }
        .char-box.correct { border-color: var(--success); background-color: #eafff2; color: var(--success); }
        .char-box.wrong { border-color: var(--error); background-color: #fff5f5; color: var(--error); animation: shake 0.4s; }
        .char-box.hint-revealed { border-color: var(--warn); color: #d35400; background: #fff8e1; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-6px); } 75% { transform: translateX(6px); } }

        /* ä¸Šä¼ ä¸å¼¹çª— */
        .section { display: none; opacity: 0; transform: translateY(15px); transition: opacity 0.4s, transform 0.4s; }
        .section.active { display: block; opacity: 1; transform: translateY(0); }
        
        .file-upload-wrapper {
            margin: 25px 0; border: 2px dashed #d1d8e0; padding: 25px; border-radius: 18px; background: #fdfdfd; cursor: pointer;
        }
        .file-upload-wrapper:hover { border-color: var(--primary-color); background: #f8f9fa; }

        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 2000; justify-content: center; align-items: center;
        }
        .modal-overlay.active { display: flex; }
        .modal-box {
            background: white; width: 85%; max-width: 480px; padding: 30px; border-radius: 24px;
            text-align: left; max-height: 75vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #f1f2f6; padding-bottom: 10px; }
        .release-item { margin-bottom: 20px; }
        .release-ver { background: var(--primary-color); color: white; padding: 2px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; margin-right: 8px; }

        /* ç»“ç®—é¡µ */
        .score-circle {
            width: 140px; height: 140px; border-radius: 50%; background: var(--warn); color: white;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            margin: 0 auto 2rem; border: 6px solid white; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .wrong-list { text-align: left; background: #fff5f5; padding: 1.5rem; border-radius: 16px; margin-bottom: 2rem; max-height: 250px; overflow-y: auto; border: 1px solid #ffccc7; }
        .wrong-item { border-bottom: 1px dashed #ffccc7; padding: 8px 0; display: flex; justify-content: space-between; }

        @media (max-width: 480px) {
            .container { width: 92%; padding: 2rem 1.5rem; }
            .char-box { width: 38px; height: 48px; font-size: 1.5rem; }
        }
    </style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>

<div class="container">
    
    <!-- 1. èµ·å§‹é¡µ -->
    <div id="setupArea" class="section active">
        <h1>English Challenge</h1>
        <p>é€‰æ‹©éš¾åº¦ï¼Œå¼€å§‹æŒ‘æˆ˜</p>
        
        <!-- éš¾åº¦é€‰æ‹©å™¨ -->
        <div class="diff-selector">
            <div class="diff-btn active" onclick="setDifficulty('easy')" data-val="easy">
                Easy<small>å¡«ç©º 30%</small>
            </div>
            <div class="diff-btn" onclick="setDifficulty('hard')" data-val="hard">
                Hard<small>å¡«ç©º 70%</small>
            </div>
            <div class="diff-btn" onclick="setDifficulty('hell')" data-val="hell">
                ğŸ”¥ Hell<small>åªç»™1å­—æ¯</small>
            </div>
        </div>

        <!-- æ¢å¤å­˜æ¡£ -->
        <div id="resumeBanner" style="display:none; background:#e0f7fa; padding:12px 20px; border-radius:12px; margin-bottom:20px; align-items:center; justify-content:space-between; color:#006064;">
            <div><strong style="font-size:0.9rem;">æœªå®Œæˆçš„æŒ‘æˆ˜</strong><br><small id="resumeInfo" style="opacity:0.8">Level 1</small></div>
            <button class="btn btn-small" style="background:#0097a7; margin:0;" onclick="resumeGame()">ç»§ç»­</button>
        </div>

        <button class="btn" style="width:80%; justify-content: center;" onclick="startWithDefault()">ğŸš€ å¼€å§‹æŒ‘æˆ˜ (éšæœº10è¯)</button>
        
        <div class="file-upload-wrapper" onclick="document.getElementById('fileInput').click()">
            <div style="font-weight:600; color:#2d3436;">ğŸ“‚ ä¸Šä¼ è‡ªå®šä¹‰é¢˜åº“ (.txt)</div>
            <div style="font-size:0.8rem; color:#b2bec3; margin-top:5px;">æ”¯æŒå¤§é‡å•è¯ï¼Œè‡ªåŠ¨éšæœºæŠ½å–</div>
            <input type="file" id="fileInput" accept=".txt,.csv" onchange="handleFileUpload(this)" style="display:none;">
        </div>

        <div style="margin-top:25px;">
            <button class="btn btn-outline btn-small" onclick="toggleModal('releaseModal')">ğŸ“œ Release Notes V2.3</button>
        </div>
    </div>

    <!-- 2. æ¸¸æˆä¸»ç•Œé¢ -->
    <div id="gameArea" class="section">
        <div class="game-toolbar">
            <div id="levelBadge" class="level-badge">Level 1</div>
            <button class="btn btn-icon" onclick="toggleSound()" id="soundToggleBtn">ğŸ”Š</button>
        </div>
        
        <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>

        <div id="wordMeaning" class="word-meaning">Meaning</div>
        <div id="wordPhonetic" class="word-phonetic" onclick="speakCurrentWord()">
            <span id="phoneticText">/IPA/</span> ğŸ”Š
        </div>

        <div id="inputContainer" class="input-container"></div>

        <div style="display:flex; justify-content:center; gap:15px; margin-top:30px;">
            <button class="btn btn-outline" onclick="useHint()" style="border-radius:12px;">ğŸ’¡ æç¤º</button>
            <button id="submitBtn" class="btn" onclick="checkCurrentWord()" style="border-radius:12px; min-width:140px;">æäº¤ / Next</button>
        </div>
    </div>

    <!-- 3. ç»“ç®—é¡µ -->
    <div id="resultArea" class="section">
        <div class="score-circle" id="scoreDisplay">
            <div class="score-val">100</div><div class="score-label">Score</div>
        </div>
        <div id="feedbackText" style="margin-bottom:2rem; font-size:1.1rem; line-height:1.6; color:#2d3436;"></div>
        
        <div id="wrongListContainer" class="wrong-list" style="display:none;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px solid #ffccc7; padding-bottom:5px;">
                <strong style="color:#d63031;">é”™é¢˜æœ¬</strong>
                <button class="btn btn-small btn-outline" style="border-color:#ff7675; color:#ff7675;" onclick="exportWrongWords()">ğŸ“¥ å¯¼å‡º</button>
            </div>
            <div id="wrongListItems"></div>
        </div>

        <div style="display:flex; justify-content:center; flex-wrap:wrap; gap:10px;">
            <button id="nextLevelBtn" class="btn" onclick="startLevel2()">ğŸ”¥ è¿›å…¥å¼ºåŒ–è®­ç»ƒ</button>
            <button id="restartBtn" class="btn" onclick="startNewSessionFromBank()" style="display:none;">ğŸ”„ æ¢ä¸€ç»„è¯</button>
            <button class="btn btn-outline" onclick="goToHome()">ğŸ  è¿”å›é¦–é¡µ</button>
        </div>
    </div>
</div>

<!-- Release Note Modal -->
<div id="releaseModal" class="modal-overlay" onclick="if(event.target===this) toggleModal('releaseModal')">
    <div class="modal-box">
        <div class="modal-header">
            <div class="modal-title">æ›´æ–°è®°å½• (Release Notes)</div>
            <button style="background:none; border:none; font-size:1.5rem; cursor:pointer;" onclick="toggleModal('releaseModal')">&times;</button>
        </div>
        
        <div class="release-item">
            <span class="release-ver">V2.3</span> <strong>éš¾åº¦åˆ†çº§ç‰ˆ</strong>
            <ul style="color:#636e72; font-size:0.9rem; margin-top:5px; padding-left:20px;">
                <li>ğŸ”¥ <strong>æ–°å¢åœ°ç‹±æ¨¡å¼ (Hell Mode)ï¼š</strong> åªæä¾› 1 ä¸ªéšæœºå­—æ¯æç¤ºï¼Œè®°å¿†å¤§å¸ˆä¸“å±æŒ‘æˆ˜ï¼</li>
                <li>ğŸšï¸ <strong>éš¾åº¦é€‰æ‹©ï¼š</strong> é¦–é¡µå¢åŠ ç®€å•(30%)ã€å›°éš¾(70%)ã€åœ°ç‹±(99%)ä¸‰ç§éš¾åº¦ã€‚</li>
                <li>ğŸ“ˆ <strong>åŠ¨æ€è¿›é˜¶ï¼š</strong> ç®€å•æ¨¡å¼çš„é”™é¢˜å°†åœ¨å›°éš¾æ¨¡å¼ä¸­å¤ä¹ ï¼›å›°éš¾æ¨¡å¼çš„é”™é¢˜å°†åœ¨åœ°ç‹±æ¨¡å¼ä¸­å¤ä¹ ã€‚</li>
            </ul>
        </div>
        
        <div class="release-item">
            <span class="release-ver">V2.2</span> <strong>çº¿ä¸Šä¼˜åŒ–ç‰ˆ</strong>
            <ul style="color:#636e72; font-size:0.9rem; margin-top:5px; padding-left:20px;">
                <li>ğŸ“± <strong>ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼š</strong> é€‚é… iOS/Android PWAï¼Œç¦ç”¨é”®ç›˜è‡ªåŠ¨çº é”™ã€‚</li>
                <li>ğŸ“š <strong>è¯åº“æ‰©å……ï¼š</strong> å†…ç½® 100+ åŸºç¡€é«˜é¢‘è¯æ±‡ã€‚</li>
            </ul>
        </div>
    </div>
</div>

<script>
    // --- é…ç½® ---
    const MAX_WORDS_PER_SESSION = 10;
    
    // --- æ•°æ® (å†…ç½®è¯åº“) ---
    const defaultData = [
        { en: "ability", ph: "/É™ËˆbÉªlÉ™ti/", cn: "èƒ½åŠ›", type: "n." }, { en: "above", ph: "/É™ËˆbÊŒv/", cn: "åœ¨â€¦ä¸Šé¢", type: "prep." },
        { en: "accident", ph: "/ËˆÃ¦ksÉªdÉ™nt/", cn: "äº‹æ•…", type: "n." }, { en: "achieve", ph: "/É™ËˆtÊƒiËv/", cn: "è¾¾åˆ°", type: "v." },
        { en: "active", ph: "/ËˆÃ¦ktÉªv/", cn: "ç§¯æçš„", type: "adj." }, { en: "advantage", ph: "/É™dËˆvÉ‘ËntÉªdÊ’/", cn: "ä¼˜ç‚¹", type: "n." },
        { en: "advice", ph: "/É™dËˆvaÉªs/", cn: "å»ºè®®", type: "n." }, { en: "against", ph: "/É™ËˆÉ¡enst/", cn: "åå¯¹", type: "prep." },
        { en: "amazing", ph: "/É™ËˆmeÉªzÉªÅ‹/", cn: "ä»¤äººæƒŠå¼‚çš„", type: "adj." }, { en: "ancient", ph: "/ËˆeÉªnÊƒÉ™nt/", cn: "å¤ä»£çš„", type: "adj." },
        { en: "animal", ph: "/ËˆÃ¦nÉªml/", cn: "åŠ¨ç‰©", type: "n." }, { en: "answer", ph: "/ËˆÉ‘ËnsÉ™/", cn: "å›ç­”", type: "n./v." },
        { en: "appear", ph: "/É™ËˆpÉªÉ™/", cn: "å‡ºç°", type: "v." }, { en: "apple", ph: "/ËˆÃ¦pl/", cn: "è‹¹æœ", type: "n." },
        { en: "area", ph: "/ËˆeÉ™riÉ™/", cn: "åœ°åŒº", type: "n." }, { en: "arrive", ph: "/É™ËˆraÉªv/", cn: "åˆ°è¾¾", type: "v." },
        { en: "attention", ph: "/É™ËˆtenÊƒn/", cn: "æ³¨æ„", type: "n." }, { en: "available", ph: "/É™ËˆveÉªlÉ™bl/", cn: "å¯è·å¾—çš„", type: "adj." },
        { en: "average", ph: "/ËˆÃ¦vÉ™rÉªdÊ’/", cn: "å¹³å‡çš„", type: "adj." }, { en: "avoid", ph: "/É™ËˆvÉ”Éªd/", cn: "é¿å…", type: "v." },
        { en: "background", ph: "/ËˆbÃ¦kÉ¡raÊŠnd/", cn: "èƒŒæ™¯", type: "n." }, { en: "balance", ph: "/ËˆbÃ¦lÉ™ns/", cn: "å¹³è¡¡", type: "n." },
        { en: "beautiful", ph: "/ËˆbjuËtÉªfl/", cn: "ç¾ä¸½çš„", type: "adj." }, { en: "because", ph: "/bÉªËˆkÉ’z/", cn: "å› ä¸º", type: "conj." },
        { en: "become", ph: "/bÉªËˆkÊŒm/", cn: "æˆä¸º", type: "v." }, { en: "before", ph: "/bÉªËˆfÉ”Ë/", cn: "ä¹‹å‰", type: "prep." },
        { en: "begin", ph: "/bÉªËˆÉ¡Éªn/", cn: "å¼€å§‹", type: "v." }, { en: "behavior", ph: "/bÉªËˆheÉªvjÉ™/", cn: "è¡Œä¸º", type: "n." },
        { en: "believe", ph: "/bÉªËˆliËv/", cn: "ç›¸ä¿¡", type: "v." }, { en: "between", ph: "/bÉªËˆtwiËn/", cn: "åœ¨â€¦ä¹‹é—´", type: "prep." }
    ];

    // --- éŸ³æ•ˆç³»ç»Ÿ ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let soundEnabled = true;

    function playTone(freq, type, duration) {
        if (!soundEnabled) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.08, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + duration);
    }
    const SFX = {
        correct: () => { playTone(500, 'sine', 0.1); setTimeout(() => playTone(800, 'sine', 0.2), 100); },
        wrong: () => { playTone(150, 'sawtooth', 0.3); },
        click: () => { playTone(400, 'triangle', 0.05); },
        win: () => { [400, 500, 600, 800].forEach((f, i) => setTimeout(() => playTone(f, 'sine', 0.2), i*120)); }
    };
    function toggleSound() { soundEnabled = !soundEnabled; document.getElementById('soundToggleBtn').textContent = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡'; }
    function speakCurrentWord() {
        if (!soundEnabled) return;
        const u = new SpeechSynthesisUtterance(activeData[gameState.queue[gameState.currentIndex]].en);
        u.lang = 'en-US'; u.rate = 0.85; window.speechSynthesis.speak(u);
    }

    // --- çŠ¶æ€ç®¡ç† ---
    let fullWordBank = [];
    let activeData = [];
    let gameState = { 
        level: 1, 
        queue: [], 
        currentIndex: 0, 
        wrongIndices: [], 
        currentWordInputs: [], 
        difficulty: 'easy' // 'easy', 'hard', 'hell'
    };

    // --- é€»è¾‘æ§åˆ¶ ---
    window.onload = function() { checkSaveData(); };

    function setDifficulty(diff) {
        gameState.difficulty = diff;
        document.querySelectorAll('.diff-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.val === diff);
        });
    }

    function toggleModal(id) { document.getElementById(id).classList.toggle('active'); }

    function checkSaveData() {
        const saved = localStorage.getItem('wordGameSave_v23');
        if (saved) {
            const parsed = JSON.parse(saved);
            if (parsed.activeData && parsed.gameState) {
                document.getElementById('resumeBanner').style.display = 'flex';
                document.getElementById('resumeInfo').textContent = `è¿›åº¦: ${parsed.gameState.currentIndex}/${parsed.gameState.queue.length} (${parsed.gameState.difficulty})`;
            }
        }
    }

    function resumeGame() {
        const saved = JSON.parse(localStorage.getItem('wordGameSave_v23'));
        activeData = saved.activeData; fullWordBank = saved.fullWordBank || activeData; gameState = saved.gameState;
        startGameCycle(false);
    }

    function saveProgress() { localStorage.setItem('wordGameSave_v23', JSON.stringify({ activeData, gameState, fullWordBank })); }
    function clearSave() { localStorage.removeItem('wordGameSave_v23'); }
    function showSection(id) { document.querySelectorAll('.section').forEach(el => el.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    
    function goToHome() { 
        showSection('setupArea'); checkSaveData(); 
        if(window.confettiInterval) clearInterval(window.confettiInterval);
        document.getElementById('confetti-canvas').getContext('2d').clearRect(0,0,window.innerWidth,window.innerHeight);
    }

    function startWithDefault() {
        fullWordBank = JSON.parse(JSON.stringify(defaultData));
        prepareGameSession();
    }

    function handleFileUpload(input) {
        const file = input.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const parsed = parseTXT(e.target.result);
            if (parsed.length > 0) {
                fullWordBank = parsed;
                alert(`å¯¼å…¥ ${parsed.length} ä¸ªå•è¯ã€‚æ¨¡å¼ï¼š${gameState.difficulty.toUpperCase()}`);
                prepareGameSession();
            } else alert("æ–‡ä»¶æ ¼å¼é”™è¯¯");
        };
        reader.readAsText(file, 'UTF-8');
    }

    function prepareGameSession() {
        if (fullWordBank.length <= MAX_WORDS_PER_SESSION) activeData = [...fullWordBank];
        else activeData = [...fullWordBank].sort(() => 0.5 - Math.random()).slice(0, MAX_WORDS_PER_SESSION);
        initGame();
    }
    function startNewSessionFromBank() { prepareGameSession(); }

    function parseTXT(c) {
        return c.split(/\r?\n/).map((l,i) => {
            if(!l.trim() || (i===0 && (l.includes('è‹±æ–‡') || l.includes('ability')))) return null;
            const p = l.split(/,|ï¼Œ/);
            return p.length>=2 ? {en:p[0].trim(), ph:p[1]?p[1].trim():'', cn:p[2]?p[2].trim():p[1].trim(), type:p[3]?p[3].trim():''} : null;
        }).filter(Boolean);
    }

    function initGame() {
        gameState.level = 1; gameState.wrongIndices = []; 
        gameState.queue = activeData.map((_, i) => i); gameState.currentIndex = 0;
        clearSave(); startGameCycle(true);
    }

    function startGameCycle(reset = false) {
        showSection('gameArea');
        const badge = document.getElementById('levelBadge');
        const diff = gameState.difficulty;
        
        let label = `Level ${gameState.level} - `;
        let color = '#00b894';

        // éš¾åº¦ä¸å…³å¡é€»è¾‘å±•ç¤º
        if (gameState.level === 1) {
            label += diff.toUpperCase();
            if(diff==='easy') color='#00b894';
            else if(diff==='hard') color='#e17055';
            else color='#6c5ce7';
        } else {
            label += "REVIEW";
            color = '#d63031'; // å¤ä¹ å…³æ€»æ˜¯çº¢è‰²çš„
        }
        
        badge.textContent = label;
        badge.style.background = color;
        
        if (reset) gameState.currentIndex = 0;
        renderWord();
    }

    function renderWord() {
        saveProgress();
        const container = document.getElementById('inputContainer'); container.innerHTML = '';
        gameState.currentWordInputs = [];

        const data = activeData[gameState.queue[gameState.currentIndex]];
        const wordStr = data.en;

        document.getElementById('wordMeaning').textContent = `${data.cn} ${data.type?'('+data.type+')':''}`;
        document.getElementById('phoneticText').textContent = data.ph || "";

        const lettersOnly = wordStr.replace(/[^a-zA-Z]/g, '');
        
        // --- æ ¸å¿ƒéš¾åº¦é€»è¾‘ ---
        let hideRatio = 0.3; 
        let isHell = false;

        if (gameState.level === 1) {
            if (gameState.difficulty === 'easy') hideRatio = 0.3;
            if (gameState.difficulty === 'hard') hideRatio = 0.7;
            if (gameState.difficulty === 'hell') isHell = true;
        } else {
            // Level 2 (å¤ä¹ å…³) éš¾åº¦è‡ªåŠ¨å‡çº§
            // Easy -> Hard(0.7), Hard/Hell -> Hell
            if (gameState.difficulty === 'easy') hideRatio = 0.7;
            else isHell = true;
        }

        let hideCount = Math.ceil(lettersOnly.length * hideRatio);
        
        // Hell æ¨¡å¼ï¼šåªä¿ç•™1ä¸ªå­—æ¯ (å³éšè— length - 1)
        if (isHell) {
            hideCount = lettersOnly.length - 1;
            if(hideCount < 0) hideCount = 0; // é˜²æ­¢å•å­—æ¯å•è¯å‡ºé”™
        } else {
            // å¸¸è§„æ¨¡å¼è‡³å°‘æŒ–1ä¸ªç©º
            if (hideCount < 1 && lettersOnly.length > 0) hideCount = 1;
        }

        let indices = [];
        for (let i=0; i<wordStr.length; i++) if (/[a-zA-Z]/.test(wordStr[i])) indices.push(i);
        indices.sort(() => Math.random() - 0.5);
        const hiddenSet = new Set(indices.slice(0, hideCount));

        for (let i=0; i<wordStr.length; i++) {
            const char = wordStr[i];
            if (char === ' ') {
                const s = document.createElement('div'); s.className = 'char-box space'; container.appendChild(s);
                gameState.currentWordInputs.push({correct: ' ', isInput: false});
            } else if (hiddenSet.has(i)) {
                const inp = document.createElement('input');
                inp.className = 'char-box'; inp.maxLength = 1; inp.dataset.correct = char;
                inp.setAttribute('autocomplete', 'off'); inp.setAttribute('autocorrect', 'off'); inp.setAttribute('spellcheck', 'false');
                inp.oninput = function() { SFX.click(); if(this.value) focusNext(this); };
                inp.onkeydown = function(e) { if(e.key === 'Backspace' && !this.value) focusPrev(this); if(e.key === 'Enter') checkCurrentWord(); };
                inp.onfocus = function() { setTimeout(() => this.scrollIntoView({behavior:'smooth', block:'center'}), 300); }
                container.appendChild(inp);
                gameState.currentWordInputs.push({correct: char, isInput: true, el: inp});
            } else {
                const d = document.createElement('div'); d.className = 'char-box static'; d.textContent = char;
                container.appendChild(d);
                gameState.currentWordInputs.push({correct: char, isInput: false});
            }
        }
        updateProgress();
        setTimeout(() => { const first = container.querySelector('input'); if(first) first.focus(); }, 100);
    }

    function focusNext(el) { let n = el.nextElementSibling; while(n) { if(n.tagName==='INPUT' && !n.disabled) { n.focus(); return; } n = n.nextElementSibling; } }
    function focusPrev(el) { let p = el.previousElementSibling; while(p) { if(p.tagName==='INPUT' && !p.disabled) { p.focus(); return; } p = p.previousElementSibling; } }
    function updateProgress() { document.getElementById('progressFill').style.width = `${(gameState.currentIndex / gameState.queue.length) * 100}%`; }

    function useHint() {
        const inputs = gameState.currentWordInputs.filter(i => i.isInput && !i.el.disabled);
        let target = inputs.find(i => i.el.value === '') || inputs.find(i => i.el.value.toLowerCase() !== i.correct.toLowerCase());
        if (target) { target.el.value = target.correct; target.el.classList.add('hint-revealed'); SFX.click(); focusNext(target.el); }
    }

    function checkCurrentWord() {
        let allCorrect = true;
        gameState.currentWordInputs.forEach(item => {
            if (item.isInput) {
                if (item.el.value.trim().toLowerCase() !== item.correct.toLowerCase()) {
                    allCorrect = false; item.el.classList.add('wrong'); item.el.classList.remove('correct');
                } else { item.el.classList.add('correct'); item.el.classList.remove('wrong'); }
            }
        });
        const currentIdx = gameState.queue[gameState.currentIndex];
        if (allCorrect) {
            SFX.correct(); speakCurrentWord();
            setTimeout(() => {
                gameState.currentIndex++;
                if (gameState.currentIndex < gameState.queue.length) renderWord(); else finishLevel();
            }, 1200);
        } else {
            SFX.wrong();
            if (gameState.level === 1 && !gameState.wrongIndices.includes(currentIdx)) gameState.wrongIndices.push(currentIdx);
        }
    }

    function finishLevel() {
        clearSave(); showSection('resultArea');
        const total = gameState.queue.length; const wrongCount = gameState.wrongIndices.length;
        const score = Math.round(((total - wrongCount) / total) * 100);
        
        document.querySelector('.score-val').textContent = score;
        const fb = document.getElementById('feedbackText');
        const nextBtn = document.getElementById('nextLevelBtn');
        const restartBtn = document.getElementById('restartBtn');
        const wrongArea = document.getElementById('wrongListContainer');
        const scoreCircle = document.getElementById('scoreDisplay');

        if (score === 100) {
            SFX.win(); startConfetti(); scoreCircle.style.background = "#00b894"; scoreCircle.style.borderColor = "#00b894";
            fb.innerHTML = "ğŸ‰ <strong>Perfect!</strong><br>å…¨éƒ¨æ­£ç¡®ï¼ä½ æ˜¯å•è¯å¤§å¸ˆï¼";
            wrongArea.style.display = 'none'; nextBtn.style.display = 'none'; restartBtn.style.display = 'inline-block';
        } else {
            scoreCircle.style.background = "#fdcb6e"; scoreCircle.style.borderColor = "#fdcb6e";
            wrongArea.style.display = 'block';
            document.getElementById('wrongListItems').innerHTML = gameState.wrongIndices.map(i => {
                const w = activeData[i]; return `<div class="wrong-item"><span style="font-weight:bold">${w.en}</span><span style="color:#e17055">${w.cn}</span></div>`;
            }).join('');
            
            if (gameState.level === 1) {
                fb.innerHTML = `å¾—åˆ† <strong>${score}</strong>ã€‚<br>é”™é¢˜å·²å‡†å¤‡å¥½ï¼Œè¿›å…¥é«˜éš¾åº¦å¤ä¹ ï¼Ÿ`;
                nextBtn.style.display = 'inline-block'; restartBtn.style.display = 'none';
            } else {
                fb.innerHTML = `å¤ä¹ å®Œæˆï¼<br>ç»è¿‡åœ°ç‹±èˆ¬çš„ç£¨ç»ƒï¼Œä½ å˜å¼ºäº†ï¼`;
                nextBtn.style.display = 'none'; restartBtn.style.display = 'inline-block';
            }
        }
    }

    function startLevel2() {
        gameState.level = 2; gameState.queue = [...gameState.wrongIndices]; gameState.currentIndex = 0;
        if(gameState.queue.length === 0) { alert("æ— é”™é¢˜ï¼"); return; }
        startGameCycle(true);
    }
    
    function exportWrongWords() {
        if (gameState.wrongIndices.length === 0) return;
        let c = "è‹±æ–‡,éŸ³æ ‡,ä¸­æ–‡,è¯æ€§\n";
        gameState.wrongIndices.forEach(i => { const w = activeData[i]; c += `${w.en},${w.ph},${w.cn},${w.type}\n`; });
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([c], {type:"text/plain"})); a.download = `review_${new Date().toISOString().slice(0,10)}.txt`; a.click();
    }

    function startConfetti() {
        const c = document.getElementById('confetti-canvas'); const ctx = c.getContext('2d');
        c.width = window.innerWidth; c.height = window.innerHeight;
        const p = Array.from({length:100}, () => ({x:Math.random()*c.width, y:Math.random()*c.height-c.height, w:Math.random()*10+5, h:Math.random()*10+5, c:['#f1c40f','#e74c3c','#3498db','#2ecc71'][Math.floor(Math.random()*4)], v:Math.random()*3+2}));
        window.confettiInterval = setInterval(() => {
            ctx.clearRect(0,0,c.width,c.height);
            p.forEach(k => { k.y+=k.v; k.x+=Math.sin(k.y*0.01); ctx.fillStyle=k.c; ctx.fillRect(k.x,k.y,k.w,k.h); if(k.y>c.height) k.y=-20; });
        }, 16);
    }
    window.onresize = () => document.getElementById('confetti-canvas').width = window.innerWidth;
</script>
</body>
</html>